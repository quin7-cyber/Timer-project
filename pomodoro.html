<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1.5rem;
            position: relative;
        }

        /* Animated gradient backgrounds */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: opacity 2s ease-in-out;
        }

        /* Morning palettes (5 AM - 11:59 AM) */
        .background.work.morning {
            background: linear-gradient(-45deg, #e3d5ff, #b8d4f1, #d4b5f7, #c7ceea);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        .background.rest.morning {
            background: linear-gradient(-45deg, #d4f1f4, #b8e6d5, #c5f5e8, #d0f0e8);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        /* Afternoon palettes (12 PM - 5:59 PM) */
        .background.work.afternoon {
            background: linear-gradient(-45deg, #ffd4a3, #ffcba4, #ffe4c4, #ffd9b3);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        .background.rest.afternoon {
            background: linear-gradient(-45deg, #ffd4c8, #ffe0d4, #f7d5b5, #fce5cd);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        /* Evening palettes (6 PM - 4:59 AM) */
        .background.work.evening {
            background: linear-gradient(-45deg, #9b9fce, #8b9dc3, #b0a8d1, #9fa8da);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        .background.rest.evening {
            background: linear-gradient(-45deg, #a8c5c5, #9fb8b5, #adc8c1, #b3ccc8);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        /* YouTube Creator Mode palette */
        .background.youtube-editing {
            background: linear-gradient(-45deg, #ffb3a3, #ffc4b8, #ffd4c8, #ffe0d4);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Particle field */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.55);
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
            animation: float 20s infinite ease-in-out;
        }

        /* Individual particle positioning and timing */
        .particle:nth-child(1) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 25s;
        }

        .particle:nth-child(2) {
            top: 60%;
            left: 80%;
            animation-delay: 3s;
            animation-duration: 30s;
        }

        .particle:nth-child(3) {
            top: 40%;
            left: 30%;
            animation-delay: 6s;
            animation-duration: 28s;
        }

        .particle:nth-child(4) {
            top: 80%;
            left: 60%;
            animation-delay: 9s;
            animation-duration: 22s;
        }

        .particle:nth-child(5) {
            top: 15%;
            left: 70%;
            animation-delay: 12s;
            animation-duration: 35s;
        }

        .particle:nth-child(6) {
            top: 70%;
            left: 20%;
            animation-delay: 15s;
            animation-duration: 27s;
        }

        .particle:nth-child(7) {
            top: 35%;
            left: 85%;
            animation-delay: 18s;
            animation-duration: 32s;
        }

        .particle:nth-child(8) {
            top: 50%;
            left: 50%;
            animation-delay: 21s;
            animation-duration: 29s;
        }

        .particle:nth-child(9) {
            top: 10%;
            left: 50%;
            animation-delay: 2s;
            animation-duration: 26s;
        }

        .particle:nth-child(10) {
            top: 55%;
            left: 15%;
            animation-delay: 5s;
            animation-duration: 31s;
        }

        .particle:nth-child(11) {
            top: 25%;
            left: 65%;
            animation-delay: 8s;
            animation-duration: 24s;
        }

        .particle:nth-child(12) {
            top: 75%;
            left: 45%;
            animation-delay: 11s;
            animation-duration: 33s;
        }

        .particle:nth-child(13) {
            top: 30%;
            left: 90%;
            animation-delay: 14s;
            animation-duration: 27s;
        }

        .particle:nth-child(14) {
            top: 65%;
            left: 35%;
            animation-delay: 17s;
            animation-duration: 29s;
        }

        .particle:nth-child(15) {
            top: 45%;
            left: 75%;
            animation-delay: 20s;
            animation-duration: 26s;
        }

        .particle:nth-child(16) {
            top: 85%;
            left: 25%;
            animation-delay: 23s;
            animation-duration: 34s;
        }

        /* Floating animation */
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.45;
            }
            25% {
                transform: translate(30px, -30px) scale(1.1);
                opacity: 0.65;
            }
            50% {
                transform: translate(-20px, 20px) scale(0.9);
                opacity: 0.55;
            }
            75% {
                transform: translate(40px, 10px) scale(1.05);
                opacity: 0.6;
            }
        }

        /* ==========================================
           THREE-PANEL LAYOUT
           ========================================== */
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 580px;
            z-index: 1;
            position: relative;
            padding: 1rem 0;
        }

        /* Section Card Base Styles - Ambient Glow Design */
        .section-card {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(16px);
            border: none;
            border-radius: 28px;
            padding: 1.5rem 2rem;
            cursor: pointer;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.8s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 0 0 1px rgba(255, 255, 255, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
        }

        .section-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1),
                        0 0 40px rgba(255, 255, 255, 0.2),
                        0 0 0 1px rgba(255, 255, 255, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        .section-card.expanded {
            cursor: default;
            animation: cardExpand 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-card.expanded:hover {
            transform: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 0 0 1px rgba(255, 255, 255, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
        }

        /* Fluid morphing animation for card expansion */
        @keyframes cardExpand {
            0% {
                transform: scale(0.98);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Section color tints with ambient glows */
        .priorities-section {
            background: rgba(184, 164, 212, 0.25);
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(184, 164, 212, 0.15),
                        0 0 60px rgba(184, 164, 212, 0.08),
                        0 0 0 1px rgba(184, 164, 212, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
        }

        .priorities-section:hover {
            box-shadow: 0 20px 50px rgba(184, 164, 212, 0.2),
                        0 0 80px rgba(184, 164, 212, 0.15),
                        0 0 0 1px rgba(184, 164, 212, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        .timer-section {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 0 60px rgba(255, 255, 255, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        .timer-section:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1),
                        0 0 80px rgba(255, 255, 255, 0.25),
                        0 0 0 1px rgba(255, 255, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.45);
        }

        .gratitude-section {
            background: rgba(159, 184, 181, 0.22);
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(159, 184, 181, 0.12),
                        0 0 60px rgba(159, 184, 181, 0.08),
                        0 0 0 1px rgba(159, 184, 181, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
        }

        .gratitude-section:hover {
            box-shadow: 0 20px 50px rgba(159, 184, 181, 0.18),
                        0 0 80px rgba(159, 184, 181, 0.12),
                        0 0 0 1px rgba(159, 184, 181, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        /* Ensure collapsed cards have consistent height */
        .section-card:not(.expanded).priorities-section,
        .section-card:not(.expanded).gratitude-section {
            min-height: 140px;
        }

        /* Time-of-day emphasis glow - enhanced ambient effect */
        .section-card.time-emphasis {
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5),
                        0 0 60px rgba(255, 255, 255, 0.2),
                        0 12px 40px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            animation: gentlePulse 4s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.5),
                            0 0 60px rgba(255, 255, 255, 0.2),
                            0 12px 40px rgba(0, 0, 0, 0.1),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.6),
                            0 0 80px rgba(255, 255, 255, 0.3),
                            0 15px 50px rgba(0, 0, 0, 0.12),
                            inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }
        }

        /* Collapsed/Expanded states with fluid morphing */
        .section-collapsed {
            display: block;
            transition: opacity 0.5s ease-out, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .section-expanded {
            display: none;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-card.expanded .section-collapsed {
            display: none;
        }

        .section-card.expanded .section-expanded {
            display: block;
            opacity: 1;
            transform: scale(1);
            animation: contentFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes contentFadeIn {
            0% {
                opacity: 0;
                transform: translateY(12px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* When a section is expanded, collapse others */
        .app-container.has-expanded .section-card:not(.expanded) {
            padding: 0.75rem 1.25rem;
            opacity: 0.6;
        }

        .app-container.has-expanded .section-card:not(.expanded):hover {
            opacity: 0.8;
            transform: none;
            box-shadow: none;
        }

        /* ==========================================
           TIMER FOCUS MODE (when timer is running)
           ========================================== */
        .app-container.timer-focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            max-width: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem 2rem;
            gap: 0;
        }

        /* Priorities at top during focus mode */
        .app-container.timer-focus-mode .priorities-section {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 400px;
            min-width: 280px;
            padding: 0.6rem 1.25rem;
            opacity: 0.7;
            z-index: 5;
            background: rgba(184, 164, 212, 0.2);
        }

        .app-container.timer-focus-mode .priorities-section:hover {
            opacity: 1;
        }

        /* Timer section in focus mode - full screen, no card */
        .app-container.timer-focus-mode .timer-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin: 4rem 0;
        }

        .app-container.timer-focus-mode .timer-section:hover {
            transform: none;
            box-shadow: none;
        }

        .app-container.timer-focus-mode .timer-section .section-collapsed {
            display: none;
        }

        .app-container.timer-focus-mode .timer-section .section-expanded {
            display: block;
            opacity: 1;
        }

        .app-container.timer-focus-mode .timer-section .section-close-btn {
            display: none;
        }

        .app-container.timer-focus-mode .timer-section .mode-switcher {
            display: none;
        }

        .app-container.timer-focus-mode .timer-section .duration-selector {
            display: none;
        }

        /* Gratitude at bottom during focus mode */
        .app-container.timer-focus-mode .gratitude-section {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 400px;
            min-width: 280px;
            padding: 0.6rem 1.25rem;
            opacity: 0.7;
            z-index: 5;
            background: rgba(159, 184, 181, 0.2);
        }

        .app-container.timer-focus-mode .gratitude-section:hover {
            opacity: 1;
        }

        /* Hide session counter during focus mode */
        .app-container.timer-focus-mode ~ .session-counter {
            display: none;
        }

        /* Hide collapsed preview content during timer focus (titles only) */
        .app-container.timer-focus-mode .priorities-section:not(.expanded) .section-collapsed .collapsed-priorities-view,
        .app-container.timer-focus-mode .priorities-section:not(.expanded) .section-collapsed .collapsed-preview-hint,
        .app-container.timer-focus-mode .gratitude-section:not(.expanded) .section-collapsed .gratitude-collapsed-status,
        .app-container.timer-focus-mode .gratitude-section:not(.expanded) .section-collapsed .collapsed-preview-hint,
        .app-container.timer-focus-mode .priorities-section:not(.expanded) .section-collapsed .priorities-progress-container,
        .app-container.timer-focus-mode .priorities-section:not(.expanded) .section-collapsed .priorities-all-done {
            display: none;
        }

        /* Show session counter when side panels expanded (not during timer) */
        .app-container.has-expanded:not(.timer-focus-mode) ~ .session-counter {
            display: block;
        }

        /* When priorities/gratitude expanded during focus mode */
        .app-container.timer-focus-mode.has-expanded .priorities-section.expanded,
        .app-container.timer-focus-mode.has-expanded .gratitude-section.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px;
            min-width: auto;
            padding: 2rem;
            opacity: 1;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .app-container.timer-focus-mode.has-expanded .timer-section {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Mobile responsive for focus mode */
        @media (max-width: 480px) {
            .app-container.timer-focus-mode {
                padding: 0.5rem 1rem;
            }

            .app-container.timer-focus-mode .priorities-section,
            .app-container.timer-focus-mode .gratitude-section {
                min-width: 200px;
                max-width: 90%;
                padding: 0.5rem 1rem;
            }

            .app-container.timer-focus-mode .timer-section {
                margin: 3rem 0;
            }
        }

        /* Close button for expanded sections */
        .section-close-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
            z-index: 20;
        }

        .section-close-btn:hover {
            background: rgba(255, 255, 255, 0.6);
            color: rgba(0, 0, 0, 0.7);
        }

        /* Section headers */
        .section-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.65);
        }

        .priorities-section .section-title,
        .gratitude-section .section-title {
            font-family: 'Inter', sans-serif;
        }

        .section-status {
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.4);
        }

        /* Collapsed section previews */
        .collapsed-preview {
            font-size: 0.95rem;
            color: rgba(0, 0, 0, 0.6);
            text-align: center;
        }

        .collapsed-preview-hint {
            font-size: 0.95rem;
            color: rgba(0, 0, 0, 0.5);
            font-style: italic;
            text-align: center;
        }

        /* Vertical centering for collapsed state */
        .priorities-section:not(.expanded) .section-collapsed,
        .gratitude-section:not(.expanded) .section-collapsed {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }

        /* Priorities collapsed view (view-only) */
        .collapsed-priorities-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 0.5rem;
        }

        .collapsed-priority-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .collapsed-priority-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.15rem 0;
        }

        .collapsed-priority-bullet {
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.4);
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .collapsed-priority-item.completed .collapsed-priority-bullet {
            color: rgba(107, 142, 126, 0.8);
        }

        .collapsed-priority-text {
            font-family: 'Playfair Display', serif;
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .collapsed-priority-item.completed .collapsed-priority-text {
            text-decoration: line-through;
            color: rgba(0, 0, 0, 0.35);
        }

        /* Progress bar */
        .priorities-progress-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .priorities-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 3px;
            overflow: hidden;
        }

        .priorities-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(107, 142, 126, 0.5), rgba(107, 142, 126, 0.7));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .priorities-progress-label {
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .priorities-all-done {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(107, 142, 126, 0.08);
            border-radius: 6px;
            font-size: 0.85rem;
            color: rgba(107, 142, 126, 0.85);
            text-align: center;
        }

        /* Timer collapsed state */
        .timer-collapsed-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .mini-timer {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.7);
        }

        .mini-timer-status {
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.5);
            margin-top: 0.25rem;
        }

        .mini-session-count {
            display: none;
        }

        /* Mode switcher in collapsed timer */
        .section-collapsed .mode-switcher {
            transform: scale(0.9);
            transform-origin: right center;
        }

        /* Gratitude collapsed state */
        .gratitude-collapsed-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gratitude-check-icon {
            color: rgba(100, 150, 100, 0.7);
        }

        .gratitude-streak-mini {
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.4);
            margin-top: 0.25rem;
        }

        /* Expanded section interiors */
        .section-card.expanded {
            padding: 3rem;
        }

        .section-card.expanded .priorities-header,
        .section-card.expanded .gratitude-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: rgba(0, 0, 0, 0.65);
            margin-bottom: 2.5rem;
            margin-top: 2rem;
            padding-right: 2.5rem;
            text-align: center;
        }

        .section-card.expanded .priority-inputs,
        .section-card.expanded .gratitude-inputs {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .section-card.expanded .priority-row,
        .section-card.expanded .gratitude-row {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            animation: softFadeIn 0.3s ease-out forwards;
        }

        .section-card.expanded .priority-row:nth-child(1),
        .section-card.expanded .gratitude-row:nth-child(1) { animation-delay: 0s; }
        .section-card.expanded .priority-row:nth-child(2),
        .section-card.expanded .gratitude-row:nth-child(2) { animation-delay: 0.05s; }
        .section-card.expanded .priority-row:nth-child(3),
        .section-card.expanded .gratitude-row:nth-child(3) { animation-delay: 0.1s; }

        .section-card.expanded .priority-number,
        .section-card.expanded .gratitude-number {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.25);
            width: 1.25rem;
            text-align: center;
        }

        .section-card.expanded .priority-input,
        .section-card.expanded .gratitude-input {
            flex: 1;
            padding: 0.75rem 0.25rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0;
            color: rgba(0, 0, 0, 0.7);
            transition: border-color 0.3s ease;
        }

        .section-card.expanded .priority-input:focus,
        .section-card.expanded .gratitude-input:focus {
            outline: none;
            border-bottom-color: rgba(0, 0, 0, 0.3);
            box-shadow: none;
        }

        .section-card.expanded .priority-input::placeholder,
        .section-card.expanded .gratitude-input::placeholder {
            color: rgba(0, 0, 0, 0.25);
            font-style: italic;
        }

        .section-card.expanded .set-priorities-btn,
        .section-card.expanded .save-gratitude-btn {
            width: 100%;
            padding: 1.1rem 2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.55);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.65);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .section-card.expanded .set-priorities-btn:hover,
        .section-card.expanded .save-gratitude-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.75);
        }

        .section-card.expanded .gratitude-actions {
            display: flex;
            justify-content: center;
        }

        /* Timer section expanded - give it more space */
        .timer-section.expanded {
            min-height: 550px;
        }

        .timer-section.expanded .timer-container {
            padding-top: 1rem;
        }

        .timer-section.expanded.time-emphasis {
            box-shadow: none;
            animation: none;
        }

        /* Hide main dashboard button when a section is expanded */
        .app-container.has-expanded ~ #main-dashboard-btn {
            display: none;
        }

        /* Mobile responsive for three-panel layout */
        @media (max-width: 480px) {
            body {
                padding: 1rem 0.75rem;
            }

            .app-container {
                gap: 0.75rem;
            }

            .section-card {
                padding: 1rem 1.25rem;
                border-radius: 16px;
            }

            .section-card.expanded {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 0;
                z-index: 50;
                overflow-y: auto;
                padding: 1.5rem;
            }

            .mini-timer {
                font-size: 2rem;
            }
        }

        /* Timer container - now used inside timer section */
        .timer-container {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        /* Focus Timer title */
        .timer-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.6);
            margin: 0 0 1.5rem 0;
        }

        /* Hide title during focus mode (timer is focal point) */
        .app-container.timer-focus-mode .timer-title {
            display: none;
        }

        /* Session label */
        .session-label {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 1.5rem;
            transition: all 0.8s ease;
        }

        /* Countdown timer */
        .countdown {
            font-family: 'Playfair Display', serif;
            font-size: 160px;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.8);
            line-height: 1;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
        }

        /* Larger countdown in focus mode */
        .app-container.timer-focus-mode .countdown {
            font-size: 180px;
            margin: 2rem 0;
        }

        .countdown .digit {
            display: inline-block;
            width: 0.7em;
            text-align: center;
        }

        .countdown .colon {
            display: inline-block;
            width: 0.3em;
            text-align: center;
        }

        /* Breathing animation */
        @keyframes breathe {
            0% {
                transform: scale(1.0);
            }
            50% {
                transform: scale(1.025);
            }
            100% {
                transform: scale(1.0);
            }
        }

        .session-label.breathing {
            animation: breathe 8s ease-in-out infinite;
        }

        /* Duration selector */
        .duration-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .duration-option {
            padding: 0.5rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            background: transparent;
            border: none;
            cursor: pointer;
            color: rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .duration-option:hover {
            color: rgba(0, 0, 0, 0.6);
            transform: scale(1.05);
        }

        .duration-option.selected {
            font-weight: 500;
            color: rgba(0, 0, 0, 0.7);
        }

        .duration-label {
            font-size: 0.85rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            color: rgba(0, 0, 0, 0.4);
            margin-left: 0.25rem;
        }

        .duration-selector.hide {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        /* Action button container - unified positioning */
        .action-buttons {
            position: relative;
            margin-top: 4rem;
            height: 52px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Start button */
        .start-button {
            position: absolute;
            padding: 1.2rem 3.5rem;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.7);
        }

        .start-button:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .start-button.hide {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        /* Rest button - identical to start button */
        .rest-button {
            position: absolute;
            padding: 1.2rem 3.5rem;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.7);
        }

        .rest-button:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .rest-button.hide {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        /* Work button - appears after rest */
        .work-button {
            position: absolute;
            padding: 1.2rem 3.5rem;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.7);
        }

        .work-button:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .work-button.hide {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        /* YouTube Start button */
        .start-youtube-btn {
            position: absolute;
            padding: 1.2rem 3.5rem;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            text-align: center;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.7);
        }

        .start-youtube-btn:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .start-youtube-btn.hide {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        /* Stop button (inside timer section) */
        .stop-button {
            display: none;
            margin-top: 1.5rem;
            padding: 0.8rem 2rem;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.6);
        }

        .stop-button.visible {
            display: inline-block;
        }

        .stop-button:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .countdown {
                font-size: 110px;
            }

            .app-container.timer-focus-mode .countdown {
                font-size: 120px;
            }

            .session-label {
                font-size: 1.2rem;
                letter-spacing: 0.2em;
            }

            .action-buttons {
                margin-top: 3rem;
                height: 46px;
            }

            .start-button,
            .rest-button,
            .work-button,
            .start-youtube-btn {
                padding: 1rem 2.5rem;
                font-size: 0.9rem;
            }

            .duration-selector {
                margin-top: 1.5rem;
            }

            .duration-option {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }

            .duration-label {
                font-size: 0.75rem;
            }

            .stop-button {
                top: 1.5rem;
                right: 1.5rem;
                padding: 0.6rem 1.5rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .countdown {
                font-size: 90px;
            }

            .app-container.timer-focus-mode .countdown {
                font-size: 100px;
            }

            .session-label {
                font-size: 1rem;
            }

            .stop-button {
                top: 1rem;
                right: 1rem;
            }
        }

        /* Session counter at bottom - hidden by design */
        .session-counter {
            display: none;
        }

        .session-counter:hover {
            opacity: 1;
        }

        .counter-label {
            font-size: 0.75rem;
            font-weight: 300;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
        }

        .counter-value {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.7);
        }

        /* Mobile responsive for session counter */
        @media (max-width: 768px) {
            .session-counter {
                bottom: 1.5rem;
            }

            .counter-label {
                font-size: 0.65rem;
            }

            .counter-value {
                font-size: 1.5rem;
            }

            /* Hide extra particles on mobile */
            .particle:nth-child(n+9) {
                display: none;
            }
        }

        /* Mode Switcher */
        .mode-switcher {
            position: relative;
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 0.25rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            min-width: fit-content;
        }

        .mode-slider {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            height: calc(100% - 0.5rem);
            /* Width set dynamically by JS based on selected option */
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .mode-option {
            position: relative;
            z-index: 1;
            flex: 1 1 auto;
            min-width: fit-content;
            padding: 0.6rem 1.25rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-align: center;
            white-space: nowrap;
            overflow: visible;
            background: transparent;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            color: rgba(0, 0, 0, 0.7);
            transform: scale(1.02);
        }

        .mode-option.selected {
            background: transparent;
            color: rgba(0, 0, 0, 0.8);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .mode-switcher {
                margin-bottom: 1.5rem;
            }

            .mode-option {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
                min-width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .mode-option {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
                letter-spacing: 0.05em;
                min-width: fit-content;
            }
        }

        /* Dashboard Button */
        .dashboard-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 0.6rem 1.2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.6);
            z-index: 10;
        }

        .dashboard-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-btn.hide {
            opacity: 0;
            pointer-events: none;
        }

        /* Dashboard View */
        .dashboard-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        .dashboard-view.hide {
            display: none;
        }

        .dashboard-back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            padding: 0.6rem 1.2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: rgba(0, 0, 0, 0.6);
        }

        .dashboard-back-btn:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-header {
            text-align: center;
            margin-bottom: 2rem;
            margin-top: 2rem;
        }

        .stats-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 1.5rem;
        }

        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 0.25rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .view-option {
            padding: 0.5rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.05em;
            background: transparent;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .view-option:hover {
            color: rgba(0, 0, 0, 0.7);
        }

        .view-option.selected {
            background: rgba(255, 255, 255, 0.6);
            color: rgba(0, 0, 0, 0.8);
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Stats Cards */
        .stats-cards {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            text-align: center;
            min-width: 140px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
        }

        /* Chart Container */
        .chart-container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .chart-container.hide {
            display: none;
        }

        #session-chart {
            width: 100%;
            height: 300px;
        }

        .chart-empty-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            font-weight: 300;
            color: rgba(0, 0, 0, 0.4);
            letter-spacing: 0.05em;
        }

        .chart-empty-message.hide {
            display: none;
        }

        /* Chart SVG styles */
        .chart-line {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chart-line.pomodoro {
            stroke: #b8a4d4;
        }

        .chart-line.youtube {
            stroke: #e8a598;
        }

        .chart-area {
            opacity: 0.15;
        }

        .chart-area.pomodoro {
            fill: #b8a4d4;
        }

        .chart-area.youtube {
            fill: #e8a598;
        }

        .chart-dot {
            cursor: pointer;
            transition: all 0.2s ease;
            transform-box: fill-box;
            transform-origin: center;
        }

        .chart-dot.pomodoro {
            fill: #b8a4d4;
        }

        .chart-dot.youtube {
            fill: #e8a598;
        }

        .chart-dot:hover {
            transform: scale(1.5);
        }

        .chart-axis {
            stroke: rgba(0, 0, 0, 0.15);
            stroke-width: 1;
        }

        .chart-grid {
            stroke: rgba(0, 0, 0, 0.05);
            stroke-width: 1;
        }

        .chart-label {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            fill: rgba(0, 0, 0, 0.4);
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(0, 0, 0, 0.6);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-color.pomodoro {
            background: #b8a4d4;
        }

        .legend-color.youtube {
            background: #e8a598;
        }

        /* Clear Data Button */
        .clear-data-btn {
            padding: 0.8rem 1.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(200, 0, 0, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(150, 0, 0, 0.7);
        }

        .clear-data-btn:hover {
            background: rgba(255, 100, 100, 0.3);
            transform: translateY(-1px);
        }

        /* Project Summary */
        .project-summary {
            width: 100%;
            max-width: 500px;
            margin-bottom: 2rem;
        }

        .project-summary.hide {
            display: none;
        }

        .section-label {
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 1rem;
            text-align: center;
        }

        .project-list-item-wrapper {
            margin-bottom: 0.5rem;
        }

        .project-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .project-list-item:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .project-list-item.expanded {
            border-radius: 12px 12px 0 0;
        }

        .project-name {
            font-weight: 500;
            color: rgba(0, 0, 0, 0.7);
        }

        .project-count {
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.5);
        }

        .project-list-empty {
            text-align: center;
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.4);
            font-style: italic;
        }

        .phase-breakdown {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 0 0 12px 12px;
            padding: 0.5rem 1rem 0.75rem 1rem;
        }

        .phase-breakdown.hide {
            display: none;
        }

        .phase-breakdown-item {
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.55);
            padding: 0.2rem 0;
            padding-left: 0.75rem;
            border-left: 2px solid rgba(0, 0, 0, 0.15);
            margin-left: 0.25rem;
        }

        /* ==========================================
           PRIORITIES DASHBOARD
           ========================================== */
        .priorities-dashboard {
            width: 100%;
            max-width: 500px;
            margin-bottom: 2rem;
        }

        .priorities-dashboard.hide {
            display: none;
        }

        .week-stats {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .week-stat-item {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            text-align: center;
        }

        .week-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.7);
        }

        .week-stat-label {
            font-size: 0.7rem;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .priorities-history {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .priority-day-card {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 1rem;
        }

        .priority-day-header {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-day-completion {
            font-size: 0.75rem;
            color: rgba(0, 0, 0, 0.4);
        }

        .priority-history-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.6);
        }

        .priority-history-item.completed {
            color: rgba(0, 0, 0, 0.4);
            text-decoration: line-through;
        }

        .priority-history-check {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .priority-history-item.completed .priority-history-check {
            background: rgba(0, 0, 0, 0.1);
        }

        .priority-history-item.completed .priority-history-check::after {
            content: '';
            color: rgba(0, 0, 0, 0.5);
        }

        /* ==========================================
           GRATITUDE DASHBOARD
           ========================================== */
        .gratitude-dashboard {
            width: 100%;
            max-width: 500px;
            margin-bottom: 2rem;
        }

        .gratitude-dashboard.hide {
            display: none;
        }

        .gratitude-streak-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .gratitude-streak-badge .streak-number {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.7);
            line-height: 1;
        }

        .gratitude-streak-badge .streak-label {
            font-size: 0.65rem;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .gratitude-journal {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .gratitude-entry-card {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 1rem;
        }

        .gratitude-entry-date {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 0.75rem;
        }

        .gratitude-entry-item {
            font-family: 'Playfair Display', serif;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.6);
            padding-left: 0.75rem;
            border-left: 2px solid rgba(159, 184, 181, 0.5);
        }

        .gratitude-empty-message {
            text-align: center;
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.4);
            font-style: italic;
            padding: 2rem 0;
        }

        /* ==========================================
           SESSION SETUP PANEL
           ========================================== */
        .session-setup {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
            width: auto;
            min-width: 280px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .session-setup.hide {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            margin: 0;
        }

        .setup-row {
            margin-bottom: 1rem;
        }

        .setup-row:last-child {
            margin-bottom: 0;
        }

        .setup-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
        }

        /* Project dropdown */
        .project-select-wrapper {
            position: relative;
        }

        .project-select {
            width: 100%;
            padding: 0.7rem 2.5rem 0.7rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            cursor: pointer;
            color: rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
        }

        .project-select:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .project-select:focus {
            outline: none;
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .project-select-wrapper::after {
            content: '';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        /* Custom project input dropdown */
        .project-input-wrapper {
            position: relative;
        }

        .project-input {
            width: 100%;
            padding: 0.7rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
        }

        .project-input:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .project-input:focus {
            outline: none;
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .project-input::placeholder {
            color: rgba(0, 0, 0, 0.35);
        }

        .project-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .project-dropdown.show {
            display: block;
        }

        .project-option {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            color: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .project-option:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .project-option.create-new {
            color: rgba(0, 0, 0, 0.5);
            font-style: italic;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Phase selector */
        .phase-select-wrapper {
            position: relative;
        }

        .phase-select {
            width: 100%;
            padding: 0.7rem 2.5rem 0.7rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            cursor: pointer;
            color: rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
        }

        .phase-select:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .phase-select:focus {
            outline: none;
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .phase-select-wrapper::after {
            content: '';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        /* Session context during timer */
        .session-context {
            text-align: center;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s ease;
            pointer-events: none;
        }

        .session-context.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .context-mode-project {
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 0.35rem;
        }

        .context-phase {
            font-size: 0.8rem;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.55);
            letter-spacing: 0.05em;
        }

        /* Saved intro preview */
        .saved-intro-preview {
            margin-top: 0.75rem;
            padding: 0.6rem 0.8rem;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            font-size: 0.75rem;
            color: rgba(0, 0, 0, 0.5);
            font-style: italic;
            display: none;
        }

        .saved-intro-preview.show {
            display: block;
        }

        .saved-intro-label {
            font-style: normal;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.6);
            margin-right: 0.25rem;
        }

        /* Mobile responsive for session setup */
        @media (max-width: 768px) {
            .session-setup {
                padding: 1rem 1.25rem;
            }
        }

        /* ==========================================
           PRIORITIES PANEL
           ========================================== */
        .priorities-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            width: auto;
            min-width: 320px;
            max-width: 400px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideDown 0.4s ease-out;
        }

        .priorities-panel.hide {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
            position: absolute;
            margin: 0;
        }

        .priorities-panel.compact {
            padding: 0.75rem 1.25rem;
            min-width: auto;
            max-width: none;
            margin-bottom: 1.5rem;
        }

        .priorities-header {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.05em;
            color: rgba(0, 0, 0, 0.7);
            margin-bottom: 1.25rem;
            text-align: center;
        }

        .priorities-panel.compact .priorities-header {
            display: none;
        }

        .priority-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .priority-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .priority-number {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.4);
            width: 1.25rem;
            text-align: center;
        }

        .priority-input {
            flex: 1;
            padding: 0.6rem 0.9rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
        }

        .priority-input:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .priority-input:focus {
            outline: none;
            border-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .priority-input::placeholder {
            color: rgba(0, 0, 0, 0.3);
        }

        .set-priorities-btn {
            margin-top: 1.25rem;
            padding: 0.9rem 2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.7);
            width: 100%;
        }

        .set-priorities-btn:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Priorities dual-mode containers */
        .priorities-edit-mode,
        .priorities-complete-mode {
            width: 100%;
        }

        .priorities-edit-mode.hide,
        .priorities-complete-mode.hide {
            display: none;
        }

        /* Expanded priority complete mode */
        .expanded-priority-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .expanded-priority-row {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem 1.5rem;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            animation: softFadeIn 0.3s ease-out forwards;
        }

        .expanded-priority-row:nth-child(1) { animation-delay: 0s; }
        .expanded-priority-row:nth-child(2) { animation-delay: 0.05s; }
        .expanded-priority-row:nth-child(3) { animation-delay: 0.1s; }

        .expanded-priority-row:hover {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(0, 0, 0, 0.12);
        }

        .expanded-priority-checkbox {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .expanded-priority-checkmark {
            width: 22px;
            height: 22px;
            border: 1.5px solid rgba(0, 0, 0, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: transparent;
        }

        .expanded-priority-row:hover .expanded-priority-checkmark {
            border-color: rgba(0, 0, 0, 0.25);
        }

        .expanded-priority-checkbox:checked ~ .expanded-priority-checkmark {
            background: transparent;
            border-color: rgba(107, 142, 126, 0.5);
        }

        .expanded-priority-checkbox:checked ~ .expanded-priority-checkmark::after {
            content: '\2713';
            font-size: 12px;
            color: rgba(107, 142, 126, 0.9);
            font-weight: 300;
        }

        .expanded-priority-number {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.25);
            width: 1.25rem;
        }

        .expanded-priority-text {
            flex: 1;
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: rgba(0, 0, 0, 0.7);
            position: relative;
            transition: color 0.4s ease;
        }

        .expanded-priority-text::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 0;
            height: 1px;
            background: rgba(0, 0, 0, 0.3);
            transition: width 0.4s ease;
        }

        .expanded-priority-row.completed .expanded-priority-text {
            color: rgba(0, 0, 0, 0.35);
        }

        .expanded-priority-row.completed .expanded-priority-text::after {
            width: 100%;
        }

        .edit-priorities-btn {
            margin-top: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.5);
            width: 100%;
        }

        .edit-priorities-btn:hover {
            background: rgba(0, 0, 0, 0.03);
            color: rgba(0, 0, 0, 0.7);
        }

        /* Expanded all complete celebration */
        .expanded-all-complete {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(107, 142, 126, 0.08);
            border: 1px solid rgba(107, 142, 126, 0.15);
            border-radius: 12px;
            text-align: center;
            color: rgba(107, 142, 126, 0.85);
            font-size: 1rem;
        }

        /* Compact priority checklist */
        .priority-checklist {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .priority-check-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0;
        }

        .priority-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.25);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.3);
        }

        .priority-check-item:hover .priority-checkbox {
            border-color: rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.5);
        }

        .priority-checkbox.checked {
            background: rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.3);
        }

        .priority-checkbox.checked::after {
            content: '';
            font-size: 12px;
            color: rgba(0, 0, 0, 0.6);
        }

        .priority-check-text {
            font-family: 'Playfair Display', serif;
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.6);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .priority-check-item.completed .priority-check-text {
            text-decoration: line-through;
            color: rgba(0, 0, 0, 0.35);
        }

        /* ==========================================
           GRATITUDE PANEL
           ========================================== */
        .gratitude-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            width: auto;
            min-width: 320px;
            max-width: 400px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideDown 0.4s ease-out;
            position: relative;
        }

        .gratitude-panel.hide {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
            position: absolute;
            margin: 0;
        }

        .gratitude-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: rgba(0, 0, 0, 0.65);
            margin-bottom: 2rem;
            text-align: center;
        }

        .gratitude-inputs {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .gratitude-row {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            animation: softFadeIn 0.3s ease-out forwards;
        }

        .gratitude-row:nth-child(1) { animation-delay: 0s; }
        .gratitude-row:nth-child(2) { animation-delay: 0.05s; }
        .gratitude-row:nth-child(3) { animation-delay: 0.1s; }

        .gratitude-number {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.25);
            width: 1.25rem;
            text-align: center;
        }

        .gratitude-input {
            flex: 1;
            padding: 0.75rem 0.25rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0;
            color: rgba(0, 0, 0, 0.7);
            transition: border-color 0.3s ease;
        }

        .gratitude-input:hover {
            border-bottom-color: rgba(0, 0, 0, 0.2);
        }

        .gratitude-input:focus {
            outline: none;
            border-bottom-color: rgba(0, 0, 0, 0.3);
            box-shadow: none;
        }

        .gratitude-input::placeholder {
            color: rgba(0, 0, 0, 0.25);
            font-style: italic;
        }

        .gratitude-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .save-gratitude-btn {
            padding: 0.9rem 2rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.7);
            flex: 1;
        }

        .save-gratitude-btn:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dismiss-gratitude-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(0, 0, 0, 0.4);
            font-size: 1.1rem;
        }

        .dismiss-gratitude-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            color: rgba(0, 0, 0, 0.6);
        }

        /* Gratitude recorded indicator */
        .gratitude-recorded {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.5);
            margin-bottom: 1rem;
        }

        .gratitude-recorded.show {
            display: inline-flex;
        }

        .gratitude-recorded-icon {
            color: rgba(100, 150, 100, 0.7);
        }

        /* Slide down animation */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Soft fade-in animation for rows */
        @keyframes softFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timer de-emphasized state */
        .timer-container.timer-secondary .countdown {
            opacity: 0.5;
            transform: scale(0.9);
        }

        .timer-container.timer-secondary .session-label {
            opacity: 0.5;
        }

        .timer-container.timer-secondary .duration-selector {
            opacity: 0.5;
        }

        /* Mobile responsive for priorities/gratitude panels */
        @media (max-width: 768px) {
            .priorities-panel,
            .gratitude-panel {
                min-width: 280px;
                padding: 1.25rem 1.5rem;
            }

            .priority-check-text {
                max-width: 80px;
            }

            .priority-checklist {
                gap: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .priorities-panel,
            .gratitude-panel {
                min-width: 260px;
                padding: 1rem 1.25rem;
            }

            .priority-checklist {
                flex-direction: column;
                align-items: flex-start;
            }

            .priority-check-text {
                max-width: 200px;
            }
        }

        /* Dashboard responsive styles */
        @media (max-width: 768px) {
            .dashboard-view {
                padding: 1.5rem;
            }

            .dashboard-btn {
                top: 1.5rem;
                left: 1.5rem;
                padding: 0.5rem 1rem;
                font-size: 0.7rem;
            }

            .dashboard-back-btn {
                top: 1.5rem;
                left: 1.5rem;
                padding: 0.5rem 1rem;
                font-size: 0.7rem;
            }

            .stats-header h2 {
                font-size: 2rem;
            }

            .view-option {
                padding: 0.4rem 0.75rem;
                font-size: 0.7rem;
            }

            .stats-cards {
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem 1.5rem;
                min-width: 100px;
            }

            .stat-value {
                font-size: 2rem;
            }

            #session-chart {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-btn {
                top: 1rem;
                left: 1rem;
            }

            .dashboard-back-btn {
                top: 1rem;
                left: 1rem;
            }

            .stats-header h2 {
                font-size: 1.5rem;
            }

            .view-toggle {
                flex-wrap: wrap;
            }

            .stat-card {
                min-width: 80px;
                padding: 0.75rem 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            #session-chart {
                height: 200px;
            }
        }

        /* ==========================================
           PHASE 1: UI REFINEMENTS
           ========================================== */

        /* Inner Glass Panels - nested containers for visual hierarchy */
        .inner-glass-panel {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
            padding: 1rem;
        }

        /* Timer display inner panel */
        .countdown-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(4px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15);
            padding: 1.5rem 2rem;
            margin: 1rem 0;
        }

        /* Priority/Gratitude input group panel */
        .input-group-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(6px);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }

        /* Top Edge Highlight - "Etched glass" effect */
        .section-card::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            border-radius: 28px 28px 0 0;
            pointer-events: none;
        }

        /* Stat cards also get the edge highlight */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            border-radius: 20px 20px 0 0;
            pointer-events: none;
        }

        .stat-card {
            position: relative;
        }

        /* Button Press Feedback */
        .start-button:active,
        .rest-button:active,
        .work-button:active,
        .start-youtube-btn:active,
        .set-priorities-btn:active,
        .save-gratitude-btn:active,
        .edit-priorities-btn:active,
        .dashboard-btn:active,
        .dashboard-back-btn:active,
        .clear-data-btn:active,
        .view-option:active,
        .mode-option:active,
        .duration-option:active {
            transform: translateY(1px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Colored Ambient Button Glows */
        .section-card.expanded .set-priorities-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1),
                        0 0 30px rgba(184, 164, 212, 0.25);
        }

        .section-card.expanded .save-gratitude-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1),
                        0 0 30px rgba(159, 184, 181, 0.25);
        }

        .edit-priorities-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1),
                        0 0 25px rgba(184, 164, 212, 0.2);
        }

        .start-button:hover,
        .work-button:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1),
                        0 0 25px rgba(255, 255, 255, 0.3);
        }

        .rest-button:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1),
                        0 0 25px rgba(159, 184, 181, 0.3);
        }

        /* ==========================================
           PHASE 2: MOTION & CEREMONY
           ========================================== */

        /* Session Completion Ceremony Overlay */
        .completion-ceremony {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .completion-ceremony.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .ceremony-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 3rem 4rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.3);
            animation: ceremonyFadeIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes ceremonyFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .ceremony-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
        }

        .ceremony-icon svg {
            width: 100%;
            height: 100%;
        }

        .ceremony-checkmark {
            stroke: #6b8e7e;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: checkmarkDraw 0.6s ease-out 0.2s forwards;
        }

        .ceremony-circle {
            stroke: rgba(107, 142, 126, 0.3);
            stroke-width: 2;
            fill: none;
        }

        @keyframes checkmarkDraw {
            0% {
                stroke-dashoffset: 100;
            }
            100% {
                stroke-dashoffset: 0;
            }
        }

        .ceremony-message {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 0.75rem;
        }

        .ceremony-stat {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 0.05em;
        }

        /* Water drop animation */
        .water-drop {
            position: fixed;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #9fb8b5, #7a9e9b);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
        }

        .water-drop.animate {
            animation: dropFall 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes dropFall {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            70% {
                opacity: 1;
                transform: translateY(300px) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translateY(350px) scale(0.5);
            }
        }

        /* SVG Checkmark Draw Animation for Priority Checkboxes */
        .priority-checkmark-svg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            opacity: 0;
            pointer-events: none;
        }

        .priority-checkmark-svg path {
            stroke: rgba(107, 142, 126, 0.9);
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            stroke-dasharray: 20;
            stroke-dashoffset: 20;
        }

        .expanded-priority-checkbox:checked ~ .priority-checkmark-svg {
            opacity: 1;
        }

        .expanded-priority-checkbox:checked ~ .priority-checkmark-svg path {
            animation: priorityCheckDraw 0.3s ease-out forwards;
        }

        @keyframes priorityCheckDraw {
            0% {
                stroke-dashoffset: 20;
            }
            100% {
                stroke-dashoffset: 0;
            }
        }

        /* Animated Number Count-Up class */
        .stat-value.counting {
            transition: none;
        }

        /* Skeleton Loading States */
        .skeleton {
            background: linear-gradient(90deg,
                rgba(255, 255, 255, 0.3) 25%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0.3) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeletonShimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 1em;
            margin: 0.25rem 0;
        }

        .skeleton-number {
            height: 2.5rem;
            width: 3rem;
            margin: 0 auto;
        }

        /* ==========================================
           PHASE 3: PROGRESS RIVER
           ========================================== */

        /* River Container */
        .progress-river {
            width: 100%;
            height: 100px;
            overflow: visible;
            margin: 1rem 0;
        }

        .progress-river.mini {
            height: 50px;
            margin: 0.5rem 0;
        }

        /* River SVG Styles */
        .river-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* River gradient definition will be in the SVG */
        .river-path {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(159, 184, 181, 0.3));
            transition: stroke-width 0.3s ease;
        }

        .river-path.shimmer {
            animation: riverShimmer 3s ease-in-out infinite;
        }

        @keyframes riverShimmer {
            0%, 100% {
                filter: drop-shadow(0 2px 4px rgba(159, 184, 181, 0.3)) brightness(1);
            }
            50% {
                filter: drop-shadow(0 2px 6px rgba(159, 184, 181, 0.5)) brightness(1.15);
            }
        }

        /* Today's segment pulse */
        .river-segment-today {
            animation: todayPulse 2s ease-in-out infinite;
        }

        @keyframes todayPulse {
            0%, 100% {
                filter: drop-shadow(0 2px 4px rgba(159, 184, 181, 0.4));
            }
            50% {
                filter: drop-shadow(0 2px 8px rgba(159, 184, 181, 0.7));
            }
        }

        /* River shore (gap day) */
        .river-shore {
            fill: rgba(210, 195, 170, 0.3);
        }

        /* River milestone markers */
        .river-milestone {
            fill: rgba(255, 255, 255, 0.9);
            stroke: rgba(159, 184, 181, 0.6);
            stroke-width: 1.5;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.1));
        }

        .river-milestone.gold {
            fill: rgba(255, 215, 0, 0.3);
            stroke: rgba(218, 165, 32, 0.6);
        }

        /* Gratitude warmth overlay */
        .river-warmth {
            fill: rgba(255, 200, 150, 0.2);
            mix-blend-mode: overlay;
        }

        /* River tooltip */
        .river-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .river-tooltip.visible {
            opacity: 1;
        }

        .river-tooltip-date {
            font-weight: 500;
            color: rgba(0, 0, 0, 0.7);
            margin-bottom: 0.25rem;
        }

        .river-tooltip-stats {
            color: rgba(0, 0, 0, 0.5);
            font-size: 0.7rem;
        }

        /* River segment hover area */
        .river-hover-area {
            fill: transparent;
            cursor: pointer;
        }

        .river-hover-area:hover + .river-path {
            filter: drop-shadow(0 2px 8px rgba(159, 184, 181, 0.6)) brightness(1.1);
        }

        /* Mini river in gratitude card */
        .gratitude-mini-river {
            margin-top: 0.75rem;
        }

        /* River in dashboard */
        .dashboard-river-container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .dashboard-river-container.hide {
            display: none;
        }

        .river-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .river-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.7);
        }

        .river-subtitle {
            font-size: 0.8rem;
            color: rgba(0, 0, 0, 0.5);
            margin-top: 0.25rem;
        }

        /* Wave animation for flowing effect */
        .river-wave {
            animation: riverWave 4s ease-in-out infinite;
        }

        @keyframes riverWave {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(2px);
            }
        }

        /* Ripple effect when drop lands */
        .river-ripple {
            fill: none;
            stroke: rgba(159, 184, 181, 0.6);
            stroke-width: 1;
            opacity: 0;
        }

        .river-ripple.animate {
            animation: rippleExpand 0.8s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                r: 5;
                opacity: 1;
            }
            100% {
                r: 25;
                opacity: 0;
            }
        }

        /* Mobile responsive for river */
        @media (max-width: 480px) {
            .progress-river {
                height: 70px;
            }

            .progress-river.mini {
                height: 40px;
            }

            .dashboard-river-container {
                padding: 1rem;
            }

            .river-title {
                font-size: 1rem;
            }
        }

        /* ==========================================
           DESIGN REFINEMENT SYSTEM
           Premium Atomic Habits Visual Cohesion
           ========================================== */

        /* ------------------------------------------
           1. BUTTON HIERARCHY SYSTEM
           Primary: Start, Save (main actions)
           Secondary: Stop, Edit, Dashboard (support)
           Tertiary: Close  (minimal)
        ------------------------------------------ */

        /* Primary Button - Main Actions */
        .start-button,
        .rest-button,
        .work-button,
        .start-youtube-btn {
            padding: 1rem 2.5rem;
            font-size: 0.95rem;
            border: 1.5px solid rgba(0, 0, 0, 0.18);
            border-radius: 50px;
        }

        .section-card.expanded .set-priorities-btn,
        .section-card.expanded .save-gratitude-btn {
            padding: 1rem 2.5rem;
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            border-radius: 50px;
            position: relative;
            overflow: hidden;
        }

        /* Secondary Button - Support Actions */
        .stop-button,
        .edit-priorities-btn,
        .dashboard-btn,
        .dashboard-back-btn,
        .clear-data-btn {
            padding: 0.85rem 2rem;
            font-size: 0.8rem;
            border-width: 1px;
            border-radius: 50px;
        }

        /* ------------------------------------------
           2. INPUT FIELD UNIFICATION
           Consistent 12px radius, unified focus glow
        ------------------------------------------ */

        .project-select,
        .project-input,
        .project-dropdown {
            border-radius: 12px;
        }

        .project-select:focus,
        .project-input:focus {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.75);
        }

        /* Priority and gratitude inputs - subtle focus enhancement */
        .section-card.expanded .priority-input:focus,
        .section-card.expanded .gratitude-input:focus {
            border-bottom-color: rgba(0, 0, 0, 0.35);
            background: linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.08) 100%);
        }

        /* ------------------------------------------
           3. CLOSE BUTTON ENHANCEMENT
           Premium inset styling with section glows
        ------------------------------------------ */

        .section-close-btn {
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.25),
                        0 2px 8px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(8px);
        }

        .section-close-btn:hover {
            background: rgba(255, 255, 255, 0.65);
            transform: scale(1.05);
        }

        /* Section-specific close button glows */
        .priorities-section .section-close-btn:hover {
            box-shadow: 0 0 20px rgba(184, 164, 212, 0.4),
                        inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .timer-section .section-close-btn:hover {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                        inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .gratitude-section .section-close-btn:hover {
            box-shadow: 0 0 20px rgba(159, 184, 181, 0.4),
                        inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* ------------------------------------------
           4. SAVE ACTION MICRO-FEEDBACK
           Success confirmation with checkmark animation
        ------------------------------------------ */

        .set-priorities-btn,
        .save-gratitude-btn {
            transition: all 0.3s ease, background-color 0.4s ease;
        }

        .set-priorities-btn.saved,
        .save-gratitude-btn.saved {
            background: rgba(107, 142, 126, 0.25) !important;
            border-color: rgba(107, 142, 126, 0.4) !important;
            color: rgba(107, 142, 126, 0.9) !important;
            animation: saveSuccessPulse 0.6s ease-out;
        }

        @keyframes saveSuccessPulse {
            0% {
                transform: scale(1);
            }
            30% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Save button checkmark icon */
        .save-checkmark {
            display: inline-block;
            width: 0;
            opacity: 0;
            transition: all 0.3s ease;
            margin-right: 0;
        }

        .set-priorities-btn.saved .save-checkmark,
        .save-gratitude-btn.saved .save-checkmark {
            width: 16px;
            opacity: 1;
            margin-right: 8px;
        }

        /* ------------------------------------------
           5. DASHBOARD GLASSMORPHISM
           Premium blur and shadow treatment
        ------------------------------------------ */

        .stat-card {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(16px);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 0 0 1px rgba(255, 255, 255, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
            border-radius: 20px;
        }

        .stat-card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08),
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(16px);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 0 60px rgba(255, 255, 255, 0.1),
                        0 0 0 1px rgba(255, 255, 255, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
            border-radius: 24px;
        }

        .view-toggle {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04),
                        0 0 0 1px rgba(255, 255, 255, 0.15);
        }

        .view-option.selected {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Dashboard project/priority/gratitude cards */
        .project-list-item,
        .priority-day-card,
        .gratitude-entry-card,
        .week-stat-item {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(12px);
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04),
                        0 0 0 1px rgba(255, 255, 255, 0.12),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-radius: 14px;
        }

        .project-list-item:hover,
        .priority-day-card:hover,
        .gratitude-entry-card:hover,
        .week-stat-item:hover {
            background: rgba(255, 255, 255, 0.45);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06),
                        0 0 0 1px rgba(255, 255, 255, 0.18),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .phase-breakdown {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
        }

        /* Gratitude streak badge glassmorphism */
        .gratitude-streak-badge {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        0 0 40px rgba(159, 184, 181, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* ------------------------------------------
           6. CHART THEME INTEGRATION
           CSS custom properties for theme-aware colors
        ------------------------------------------ */

        :root {
            --chart-pomodoro: rgba(184, 164, 212, 1);
            --chart-pomodoro-light: rgba(184, 164, 212, 0.15);
            --chart-youtube: rgba(232, 165, 152, 1);
            --chart-youtube-light: rgba(232, 165, 152, 0.15);
        }

        /* Morning theme - cooler purples */
        body.morning {
            --chart-pomodoro: rgba(179, 157, 219, 1);
            --chart-pomodoro-light: rgba(179, 157, 219, 0.15);
            --chart-youtube: rgba(225, 170, 165, 1);
            --chart-youtube-light: rgba(225, 170, 165, 0.15);
        }

        /* Afternoon theme - warmer tones */
        body.afternoon {
            --chart-pomodoro: rgba(200, 175, 180, 1);
            --chart-pomodoro-light: rgba(200, 175, 180, 0.15);
            --chart-youtube: rgba(235, 160, 140, 1);
            --chart-youtube-light: rgba(235, 160, 140, 0.15);
        }

        /* Evening theme - muted colors */
        body.evening {
            --chart-pomodoro: rgba(160, 155, 190, 1);
            --chart-pomodoro-light: rgba(160, 155, 190, 0.15);
            --chart-youtube: rgba(200, 165, 160, 1);
            --chart-youtube-light: rgba(200, 165, 160, 0.15);
        }

        /* Apply theme colors to chart elements */
        .chart-line.pomodoro {
            stroke: var(--chart-pomodoro, #b8a4d4);
        }

        .chart-line.youtube {
            stroke: var(--chart-youtube, #e8a598);
        }

        .chart-area.pomodoro {
            fill: var(--chart-pomodoro, #b8a4d4);
        }

        .chart-area.youtube {
            fill: var(--chart-youtube, #e8a598);
        }

        .chart-dot.pomodoro {
            fill: var(--chart-pomodoro, #b8a4d4);
        }

        .chart-dot.youtube {
            fill: var(--chart-youtube, #e8a598);
        }

        .legend-color.pomodoro {
            background: var(--chart-pomodoro, #b8a4d4);
        }

        .legend-color.youtube {
            background: var(--chart-youtube, #e8a598);
        }

        /* ------------------------------------------
           7. CORNER RADIUS HIERARCHY
           Main cards: 28px, Nested: 14px, Chips: 8px
        ------------------------------------------ */

        /* Main cards stay at 28px (already set) */

        /* Nested elements - 14px radius */
        .priority-day-card,
        .gratitude-entry-card,
        .project-list-item,
        .week-stat-item,
        .expanded-all-complete,
        .priorities-all-done {
            border-radius: 14px;
        }

        .project-list-item.expanded {
            border-radius: 14px 14px 0 0;
        }

        .phase-breakdown {
            border-radius: 0 0 14px 14px;
        }

        /* Chips and badges - 8px radius */
        .priority-checkbox {
            border-radius: 6px;
        }

        .priority-history-check {
            border-radius: 4px;
        }

        .priorities-progress-bar {
            border-radius: 4px;
        }

        .priorities-progress-fill {
            border-radius: 4px;
        }

        /* ------------------------------------------
           8. FOCUS MODE POLISH
           Enhanced tunnel vision with desaturation
        ------------------------------------------ */

        /* Subtle desaturation for collapsed panels during focus */
        .app-container.timer-focus-mode .priorities-section:not(.expanded),
        .app-container.timer-focus-mode .gratitude-section:not(.expanded) {
            filter: saturate(0.7) brightness(0.98);
            transition: all 0.5s ease, filter 0.8s ease;
        }

        .app-container.timer-focus-mode .priorities-section:not(.expanded):hover,
        .app-container.timer-focus-mode .gratitude-section:not(.expanded):hover {
            filter: saturate(1) brightness(1);
            opacity: 1;
        }

        /* Enhanced blur on non-active sections during focus */
        .app-container.timer-focus-mode.has-expanded .timer-section {
            filter: blur(4px) saturate(0.6);
            opacity: 0.25;
        }

        /* Smooth transition for focus mode entry */
        .app-container.timer-focus-mode .timer-section {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ensure expanded panels during focus are crisp */
        .app-container.timer-focus-mode.has-expanded .priorities-section.expanded,
        .app-container.timer-focus-mode.has-expanded .gratitude-section.expanded {
            filter: none;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2),
                        0 0 100px rgba(255, 255, 255, 0.15);
        }

    </style>
</head>
<body>
    <div class="background work"></div>

    <!-- Particle field -->
    <div class="particles">
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
        <span class="particle"></span>
    </div>

    <!-- Three-Panel App Container -->
    <div class="app-container" id="app-container">
        <!-- ==========================================
             PRIORITIES SECTION (Top)
             ========================================== -->
        <div class="section-card priorities-section" data-section="priorities" id="priorities-section">
            <!-- Collapsed State -->
            <div class="section-collapsed" id="priorities-collapsed">
                <div class="section-header">
                    <span class="section-title">Top 3 Priorities</span>
                    <span class="section-status" id="priorities-status"></span>
                </div>
                <div id="priorities-collapsed-content">
                    <!-- Populated dynamically: either hint or checklist -->
                </div>
            </div>

            <!-- Expanded State -->
            <div class="section-expanded" id="priorities-expanded">
                <button class="section-close-btn" data-close="priorities">&times;</button>

                <!-- Edit Mode (setting/editing priorities) -->
                <div class="priorities-edit-mode" id="priorities-edit-mode">
                    <div class="priorities-header">What are your top 3 priorities today?</div>
                    <div class="priority-inputs">
                        <div class="priority-row">
                            <span class="priority-number">1</span>
                            <input type="text" class="priority-input" id="priority-1" placeholder="First priority..." maxlength="100">
                        </div>
                        <div class="priority-row">
                            <span class="priority-number">2</span>
                            <input type="text" class="priority-input" id="priority-2" placeholder="Second priority..." maxlength="100">
                        </div>
                        <div class="priority-row">
                            <span class="priority-number">3</span>
                            <input type="text" class="priority-input" id="priority-3" placeholder="Third priority..." maxlength="100">
                        </div>
                    </div>
                    <button class="set-priorities-btn"><span class="save-checkmark"></span><span class="btn-text">Set Priorities</span></button>
                </div>

                <!-- Complete Mode (interactive checkboxes) -->
                <div class="priorities-complete-mode hide" id="priorities-complete-mode">
                    <div class="priorities-header">Today's Priorities</div>
                    <div class="expanded-priority-list" id="expanded-priority-list">
                        <!-- Dynamically populated -->
                    </div>
                    <button class="edit-priorities-btn">Edit Priorities</button>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TIMER SECTION (Middle - Hero)
             ========================================== -->
        <div class="section-card timer-section" data-section="timer" id="timer-section">
            <!-- Collapsed State -->
            <div class="section-collapsed" id="timer-collapsed">
                <div class="section-header">
                    <span class="section-title">Focus Timer</span>
                    <span class="mini-session-count" id="mini-session-count"></span>
                </div>
                <div class="timer-collapsed-display">
                    <div>
                        <div class="mini-timer" id="mini-timer">25:00</div>
                        <div class="mini-timer-status" id="mini-timer-status">Ready</div>
                    </div>
                    <div class="mode-switcher" style="margin-bottom: 0;">
                        <div class="mode-slider"></div>
                        <button class="mode-option selected" data-mode="pomodoro">Work</button>
                        <button class="mode-option" data-mode="youtube">Quinlan Travels</button>
                    </div>
                </div>
            </div>

            <!-- Expanded State -->
            <div class="section-expanded" id="timer-expanded">
                <button class="section-close-btn" data-close="timer">&times;</button>
                <div class="timer-container">
                    <h2 class="timer-title">Focus Timer</h2>
                    <div class="mode-switcher">
                        <div class="mode-slider"></div>
                        <button class="mode-option selected" data-mode="pomodoro">Work</button>
                        <button class="mode-option" data-mode="youtube">Quinlan Travels</button>
                    </div>

                    <!-- Session Setup Panel -->
                    <div class="session-setup">
                        <div class="setup-row">
                            <label class="setup-label">Project</label>
                            <div class="project-input-wrapper">
                                <input type="text" class="project-input" placeholder="Select or type project..." autocomplete="off">
                                <div class="project-dropdown"></div>
                            </div>
                            <div class="saved-intro-preview">
                                <span class="saved-intro-label">Best intro:</span>
                                <span class="saved-intro-text"></span>
                            </div>
                        </div>
                        <div class="setup-row">
                            <label class="setup-label">Phase</label>
                            <div class="phase-select-wrapper">
                                <select class="phase-select"></select>
                            </div>
                        </div>
                    </div>

                    <!-- Session context (shown during timer) -->
                    <div class="session-context">
                        <div class="context-mode-project"></div>
                        <div class="context-phase"></div>
                    </div>

                    <div class="session-label">Work</div>
                    <div class="countdown">
                        <span class="digit" id="min-tens">2</span>
                        <span class="digit" id="min-ones">5</span>
                        <span class="colon">:</span>
                        <span class="digit" id="sec-tens">0</span>
                        <span class="digit" id="sec-ones">0</span>
                    </div>
                    <div class="duration-selector">
                        <button class="duration-option" data-duration="15">15</button>
                        <button class="duration-option" data-duration="20">20</button>
                        <button class="duration-option selected" data-duration="25">25</button>
                        <span class="duration-label">min</span>
                    </div>
                    <div class="action-buttons">
                        <button class="start-button">Begin</button>
                        <button class="rest-button hide">Start Rest</button>
                        <button class="work-button hide">Start Work</button>
                        <button class="start-youtube-btn hide">Start</button>
                    </div>

                    <button class="stop-button">Reset</button>
                </div>
            </div>
        </div>

        <!-- ==========================================
             GRATITUDE SECTION (Bottom)
             ========================================== -->
        <div class="section-card gratitude-section" data-section="gratitude" id="gratitude-section">
            <!-- Collapsed State -->
            <div class="section-collapsed" id="gratitude-collapsed">
                <div class="section-header">
                    <span class="section-title">Gratitude Journal</span>
                    <span class="section-status" id="gratitude-status"></span>
                </div>
                <div id="gratitude-collapsed-content">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Expanded State -->
            <div class="section-expanded" id="gratitude-expanded">
                <button class="section-close-btn" data-close="gratitude">&times;</button>
                <div class="gratitude-header">What are you grateful for today?</div>
                <div class="gratitude-inputs">
                    <div class="gratitude-row">
                        <span class="gratitude-number">1</span>
                        <input type="text" class="gratitude-input" id="gratitude-1" placeholder="Something good..." maxlength="150">
                    </div>
                    <div class="gratitude-row">
                        <span class="gratitude-number">2</span>
                        <input type="text" class="gratitude-input" id="gratitude-2" placeholder="Another moment..." maxlength="150">
                    </div>
                    <div class="gratitude-row">
                        <span class="gratitude-number">3</span>
                        <input type="text" class="gratitude-input" id="gratitude-3" placeholder="One more thing..." maxlength="150">
                    </div>
                </div>
                <div class="gratitude-actions">
                    <button class="save-gratitude-btn"><span class="save-checkmark"></span><span class="btn-text">Save Gratitude</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Session counter moved to bottom of page -->
    <div class="session-counter" style="position: relative; bottom: auto; left: auto; transform: none; margin-top: 1rem;">
        <div class="counter-label">Sessions Today</div>
        <div class="counter-value" id="session-count">0</div>
    </div>

    <!-- Session Completion Ceremony Overlay -->
    <div class="completion-ceremony" id="completion-ceremony">
        <div class="ceremony-content">
            <div class="ceremony-icon">
                <svg viewBox="0 0 80 80">
                    <circle class="ceremony-circle" cx="40" cy="40" r="35"/>
                    <path class="ceremony-checkmark" d="M24 42 L35 53 L56 28"/>
                </svg>
            </div>
            <div class="ceremony-message">Session Complete</div>
            <div class="ceremony-stat" id="ceremony-stat">That's 1 session today</div>
        </div>
    </div>

    <!-- Water Drop Animation Element -->
    <div class="water-drop" id="water-drop"></div>

    <!-- River Tooltip -->
    <div class="river-tooltip" id="river-tooltip">
        <div class="river-tooltip-date"></div>
        <div class="river-tooltip-stats"></div>
    </div>

    <!-- Dashboard view -->
    <div class="dashboard-view hide">
        <button class="dashboard-back-btn">Back</button>
        <div class="stats-header">
            <h2>Your Progress</h2>
            <div class="view-toggle">
                <button class="view-option selected" data-view="combined">Combined</button>
                <button class="view-option" data-view="pomodoro">Work</button>
                <button class="view-option" data-view="youtube">Quinlan Travels</button>
                <button class="view-option" data-view="priorities">Priorities</button>
                <button class="view-option" data-view="gratitude">Gratitude</button>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-label">Days Active</div>
                <div class="stat-value" id="days-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Today's Sessions</div>
                <div class="stat-value" id="today-sessions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Sessions</div>
                <div class="stat-value" id="total-sessions">0</div>
            </div>
            <div class="stat-card stat-card-priorities hide" id="stat-priority">
                <div class="stat-label">Weekly Priority %</div>
                <div class="stat-value" id="priority-percent">0%</div>
            </div>
            <div class="stat-card stat-card-gratitude hide" id="stat-gratitude">
                <div class="stat-label">Gratitude Streak</div>
                <div class="stat-value" id="gratitude-streak">0</div>
            </div>
        </div>

        <!-- Progress River Visualization -->
        <div class="dashboard-river-container" id="dashboard-river-container">
            <div class="river-header">
                <div class="river-title">Your Progress River</div>
                <div class="river-subtitle">Each day adds to the flow</div>
            </div>
            <div class="progress-river" id="dashboard-river">
                <svg class="river-svg" id="river-svg" viewBox="0 0 760 100" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <linearGradient id="riverGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#9fb8b5;stop-opacity:0.8"/>
                            <stop offset="100%" style="stop-color:#7a9e9b;stop-opacity:1"/>
                        </linearGradient>
                        <linearGradient id="riverGradientWarm" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#b8c5a8;stop-opacity:0.8"/>
                            <stop offset="100%" style="stop-color:#9fb8a0;stop-opacity:1"/>
                        </linearGradient>
                    </defs>
                    <!-- River path will be generated dynamically -->
                    <g id="river-content"></g>
                </svg>
            </div>
        </div>

        <div class="chart-container">
            <svg id="session-chart"></svg>
            <div class="chart-empty-message hide">No sessions recorded yet</div>
        </div>

        <div class="project-summary hide" id="project-summary">
            <h3 class="section-label">Projects</h3>
            <div class="project-list" id="project-list">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Priorities Dashboard View -->
        <div class="priorities-dashboard hide" id="priorities-dashboard">
            <h3 class="section-label">This Week's Priorities</h3>
            <div class="week-stats" id="week-priority-stats">
                <!-- Populated dynamically -->
            </div>
            <div class="priorities-history" id="priorities-history">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Gratitude Dashboard View -->
        <div class="gratitude-dashboard hide" id="gratitude-dashboard">
            <div class="gratitude-streak-badge" id="gratitude-streak-badge">
                <span class="streak-number">0</span>
                <span class="streak-label">day streak</span>
            </div>
            <h3 class="section-label">Gratitude Journal</h3>
            <div class="gratitude-journal" id="gratitude-journal">
                <!-- Populated dynamically -->
            </div>
        </div>

        <button class="clear-data-btn">Clear All Data</button>
    </div>

    <!-- Dashboard button (shown in main view) -->
    <button class="dashboard-btn" id="main-dashboard-btn" style="position: fixed; top: 2rem; right: 2rem; left: auto;">Stats</button>

    <script>
        // Timer state
        let timerInterval = null;
        const trackedIntervals = []; // Track all intervals for cleanup
        let workDuration = 25; // Selected work duration in minutes
        let remainingSeconds = workDuration * 60;
        let isWorkSession = true;
        let isRunning = false;
        let sessionCount = 0;
        let sessionRecorded = false;  // Prevents duplicate session recordings
        let endTime = null;

        // Mode state
        let currentMode = 'pomodoro'; // 'pomodoro' or 'youtube'

        // Three-panel layout state
        let expandedSection = null; // 'priorities' | 'timer' | 'gratitude' | null

        // Video production phases
        const VIDEO_PHASES = [
            { id: 'idea', label: 'Idea / Angle' },
            { id: 'outline', label: 'Outline / Beat sheet' },
            { id: 'script', label: 'Script / Voiceover polish' },
            { id: 'edit', label: 'Edit (assembly)' },
            { id: 'retention', label: 'Retention pass' },
            { id: 'intro', label: 'Intro build (clinic)' },
            { id: 'packaging', label: 'Packaging' },
            { id: 'upload', label: 'Upload / Description / Chapters' }
        ];
        let youtubePhase = 'idea'; // Current phase ID

        // Session setup state
        let currentProject = '';

        // YouTube timer duration (in seconds) - all phases use 20 minutes
        const YOUTUBE_SESSION_DURATION = 20 * 60;

        // Project storage key
        const PROJECTS_STORAGE_KEY = 'pomodoro_projects';

        // DOM elements
        const minTensEl = document.getElementById('min-tens');
        const minOnesEl = document.getElementById('min-ones');
        const secTensEl = document.getElementById('sec-tens');
        const secOnesEl = document.getElementById('sec-ones');
        const sessionCountEl = document.getElementById('session-count');
        const sessionLabelEl = document.querySelector('.session-label');
        const startButton = document.querySelector('.start-button');
        const restButton = document.querySelector('.rest-button');
        const workButton = document.querySelector('.work-button');
        const stopButton = document.querySelector('.stop-button');
        const backgroundEl = document.querySelector('.background');
        const durationSelector = document.querySelector('.duration-selector');
        const durationOptions = document.querySelectorAll('.duration-option');

        // Mode switcher elements
        const modeOptions = document.querySelectorAll('.mode-option');
        const modeSlider = document.querySelector('.mode-slider');
        const startYoutubeBtn = document.querySelector('.start-youtube-btn');

        // Session setup elements
        const sessionSetup = document.querySelector('.session-setup');
        const projectInput = document.querySelector('.project-input');
        const projectDropdown = document.querySelector('.project-dropdown');
        const phaseSelect = document.querySelector('.phase-select');
        const sessionContext = document.querySelector('.session-context');
        const contextModeProject = document.querySelector('.context-mode-project');
        const contextPhase = document.querySelector('.context-phase');
        const savedIntroPreview = document.querySelector('.saved-intro-preview');
        const savedIntroText = document.querySelector('.saved-intro-text');

        // Three-panel layout elements
        const appContainer = document.getElementById('app-container');
        const prioritiesSection = document.getElementById('priorities-section');
        const timerSection = document.getElementById('timer-section');
        const gratitudeSection = document.getElementById('gratitude-section');
        const prioritiesCollapsedContent = document.getElementById('priorities-collapsed-content');
        const prioritiesStatus = document.getElementById('priorities-status');
        const gratitudeCollapsedContent = document.getElementById('gratitude-collapsed-content');
        const gratitudeStatus = document.getElementById('gratitude-status');
        const miniTimer = document.getElementById('mini-timer');
        const miniTimerStatus = document.getElementById('mini-timer-status');
        const miniSessionCount = document.getElementById('mini-session-count');
        const mainDashboardBtn = document.getElementById('main-dashboard-btn');

        // Mode switchers (both collapsed and expanded have them)
        const allModeOptions = document.querySelectorAll('.mode-option');
        const allModeSliders = document.querySelectorAll('.mode-slider');

        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Get time of day based on current hour
        function getTimeOfDay() {
            const hour = new Date().getHours();

            if (hour >= 5 && hour < 12) {
                return 'morning';
            } else if (hour >= 12 && hour < 18) {
                return 'afternoon';
            } else {
                return 'evening';
            }
        }

        // Apply time-of-day class to body for theme integration
        function updateBodyTimeClass() {
            const timeOfDay = getTimeOfDay();
            document.body.classList.remove('morning', 'afternoon', 'evening');
            document.body.classList.add(timeOfDay);
        }
        updateBodyTimeClass();
        // Update every 5 minutes
        trackedIntervals.push(setInterval(updateBodyTimeClass, 5 * 60 * 1000));

        // ==========================================
        // SAVE FEEDBACK HELPER
        // ==========================================
        function showSaveFeedback(button, originalText) {
            const btnTextEl = button.querySelector('.btn-text');
            if (!btnTextEl) return;

            button.classList.add('saved');
            btnTextEl.textContent = 'Saved!';

            setTimeout(() => {
                button.classList.remove('saved');
                btnTextEl.textContent = originalText;
            }, 1500);
        }

        // ==========================================
        // THREE-PANEL EXPAND/COLLAPSE MANAGEMENT
        // ==========================================

        // Expand a section
        function expandSection(sectionName) {
            if (expandedSection === sectionName) return;

            // Collapse any currently expanded section
            collapseAllSections();

            // Expand the selected section
            expandedSection = sectionName;
            appContainer.classList.add('has-expanded');

            const section = document.getElementById(`${sectionName}-section`);
            if (section) {
                section.classList.add('expanded');
            }

            // Update priorities expanded view when opening priorities section
            if (sectionName === 'priorities') {
                updateExpandedPrioritiesView();
            }

            // Populate gratitude inputs when opening gratitude section
            if (sectionName === 'gratitude') {
                populateGratitudeInputs();
            }

            // Reinitialize mode sliders when timer section expands
            if (sectionName === 'timer') {
                requestAnimationFrame(() => {
                    initializeModeSliders();
                });
            }
        }

        // Collapse all sections
        function collapseAllSections() {
            expandedSection = null;
            appContainer.classList.remove('has-expanded');

            document.querySelectorAll('.section-card').forEach(card => {
                card.classList.remove('expanded');
            });

            // Update all previews
            updatePrioritiesCollapsedPreview();
            updateTimerCollapsedPreview();
            updateGratitudeCollapsedPreview();
            updateTimeOfDayEmphasis();
        }

        // Update priorities collapsed preview (view-only with progress bar)
        function updatePrioritiesCollapsedPreview() {
            if (!prioritiesStatus || !prioritiesCollapsedContent) return;

            const todayData = getTodayPriorities();

            if (!todayData) {
                // Not set yet
                prioritiesStatus.textContent = '';
                prioritiesCollapsedContent.innerHTML = '<div class="collapsed-preview-hint">Set your top 3 for today</div>';
            } else {
                // Show view-only list with progress bar
                const completed = todayData.priorities.filter(p => p.completed).length;
                const total = todayData.priorities.length;
                const percentage = Math.round((completed / total) * 100);
                prioritiesStatus.textContent = completed === total ? `${total}/${total} ` : `${completed}/${total}`;

                let html = `
                    <div class="collapsed-priorities-view">
                        <div class="collapsed-priority-list">
                            ${todayData.priorities.map(p => `
                                <div class="collapsed-priority-item ${p.completed ? 'completed' : ''}">
                                    <span class="collapsed-priority-bullet">${p.completed ? '' : ''}</span>
                                    <span class="collapsed-priority-text">${p.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="priorities-progress-container">
                            <div class="priorities-progress-bar">
                                <div class="priorities-progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                `;

                if (completed === total) {
                    html += `<div class="priorities-all-done">All priorities complete!</div>`;
                }

                html += `</div>`;
                prioritiesCollapsedContent.innerHTML = html;
            }
        }

        // Update expanded priorities view (show edit mode or complete mode)
        function updateExpandedPrioritiesView() {
            const todayData = getTodayPriorities();
            const editMode = document.getElementById('priorities-edit-mode');
            const completeMode = document.getElementById('priorities-complete-mode');
            const expandedList = document.getElementById('expanded-priority-list');

            if (!todayData) {
                // No priorities set - show edit mode
                editMode.classList.remove('hide');
                completeMode.classList.add('hide');
                // Clear inputs
                priorityInputs.forEach(input => input.value = '');
            } else {
                // Priorities exist - show complete mode with checkboxes
                editMode.classList.add('hide');
                completeMode.classList.remove('hide');

                const completed = todayData.priorities.filter(p => p.completed).length;
                const total = todayData.priorities.length;
                const allDone = completed === total;

                let html = '';

                if (allDone) {
                    html += `<div class="expanded-all-complete">All priorities complete! Great work!</div>`;
                }

                html += todayData.priorities.map((p, i) => `
                    <label class="expanded-priority-row ${p.completed ? 'completed' : ''}" data-index="${i}">
                        <input type="checkbox" class="expanded-priority-checkbox" ${p.completed ? 'checked' : ''}>
                        <span class="expanded-priority-checkmark"></span>
                        <span class="expanded-priority-number">${i + 1}</span>
                        <span class="expanded-priority-text">${p.text}</span>
                    </label>
                `).join('');

                expandedList.innerHTML = html;
            }
        }

        // Use change event on the container (event delegation)
        const expandedPriorityList = document.getElementById('expanded-priority-list');
        if (expandedPriorityList) {
            expandedPriorityList.addEventListener('change', (e) => {
                if (e.target.classList.contains('expanded-priority-checkbox')) {
                    const row = e.target.closest('.expanded-priority-row');
                    if (row) {
                        togglePriorityCompletion(parseInt(row.dataset.index));
                        updateExpandedPrioritiesView();
                        updatePrioritiesCollapsedPreview();
                    }
                }
            });
        }

        // Switch to edit mode in expanded view
        function switchToEditMode() {
            const todayData = getTodayPriorities();
            const editMode = document.getElementById('priorities-edit-mode');
            const completeMode = document.getElementById('priorities-complete-mode');

            // Populate inputs with current priority text
            if (todayData) {
                todayData.priorities.forEach((p, i) => {
                    if (priorityInputs[i]) {
                        priorityInputs[i].value = p.text;
                    }
                });
            }

            // Switch views
            editMode.classList.remove('hide');
            completeMode.classList.add('hide');

            // Focus first input
            if (priorityInputs[0]) {
                priorityInputs[0].focus();
            }
        }

        // Update timer collapsed preview
        function updateTimerCollapsedPreview() {
            const mins = Math.floor(remainingSeconds / 60);
            const secs = remainingSeconds % 60;
            if (miniTimer) miniTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            if (miniTimerStatus) {
                if (isRunning) {
                    miniTimerStatus.textContent = isWorkSession ? 'Working...' : 'Resting...';
                } else {
                    miniTimerStatus.textContent = 'Ready';
                }
            }

            // Update session count
            if (miniSessionCount) miniSessionCount.textContent = `${sessionCount} today`;
        }

        // Update gratitude collapsed preview
        function updateGratitudeCollapsedPreview() {
            if (!gratitudeStatus || !gratitudeCollapsedContent) return;

            const todayData = getTodayGratitude();
            const gratitudeData = loadGratitude();
            const streak = gratitudeData.stats.currentStreak || 0;

            if (!todayData) {
                // Not recorded yet
                gratitudeStatus.textContent = '';
                gratitudeCollapsedContent.innerHTML = `
                    <div class="collapsed-preview-hint">What are you grateful for?</div>
                    ${streak > 0 ? `<div class="gratitude-streak-mini">${streak} day streak</div>` : ''}
                `;
            } else {
                // Recorded
                gratitudeStatus.textContent = '';
                gratitudeCollapsedContent.innerHTML = `
                    <div class="gratitude-collapsed-status">
                        <span class="gratitude-check-icon"></span>
                        <span>Today's gratitude saved</span>
                    </div>
                    ${streak > 0 ? `<div class="gratitude-streak-mini">${streak} day streak</div>` : ''}
                `;
            }

            // Render mini river (will be added after the status content)
            if (typeof renderMiniRiver === 'function') {
                setTimeout(() => renderMiniRiver(), 0);
            }
        }

        // Update time-of-day emphasis
        function updateTimeOfDayEmphasis() {
            const timeOfDay = getTimeOfDay();

            // Remove all emphasis
            prioritiesSection.classList.remove('time-emphasis');
            timerSection.classList.remove('time-emphasis');
            gratitudeSection.classList.remove('time-emphasis');

            // Add emphasis based on time of day
            if (timeOfDay === 'morning') {
                prioritiesSection.classList.add('time-emphasis');
            } else if (timeOfDay === 'afternoon') {
                timerSection.classList.add('time-emphasis');
            } else {
                gratitudeSection.classList.add('time-emphasis');
            }
        }

        // Section click handlers
        function setupSectionClickHandlers() {
            // Click on section to expand
            document.querySelectorAll('.section-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't expand if clicking on close button or input
                    if (e.target.closest('.section-close-btn') ||
                        e.target.closest('input') ||
                        e.target.closest('select') ||
                        e.target.closest('button:not(.mode-option)') ||
                        e.target.closest('.expanded-priority-row')) {
                        return;
                    }

                    const sectionName = card.dataset.section;
                    if (!card.classList.contains('expanded')) {
                        expandSection(sectionName);
                    }
                });
            });

            // Close button handlers
            document.querySelectorAll('.section-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    collapseAllSections();
                });
            });

            // Keyboard accessibility
            document.querySelectorAll('.section-card').forEach(card => {
                card.setAttribute('tabindex', '0');
                card.addEventListener('keydown', (e) => {
                    // Don't intercept keyboard events from input/textarea/select elements
                    if (e.target.matches('input, textarea, select')) {
                        return;
                    }
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const sectionName = card.dataset.section;
                        if (!card.classList.contains('expanded')) {
                            expandSection(sectionName);
                        }
                    }
                    if (e.key === 'Escape' && card.classList.contains('expanded')) {
                        collapseAllSections();
                    }
                });
            });
        }

        // Format time as individual digits
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;

            return {
                minTens: Math.floor(mins / 10),
                minOnes: mins % 10,
                secTens: Math.floor(secs / 10),
                secOnes: secs % 10
            };
        }

        // Update display
        function updateDisplay() {
            const time = formatTime(remainingSeconds);
            if (minTensEl) minTensEl.textContent = time.minTens;
            if (minOnesEl) minOnesEl.textContent = time.minOnes;
            if (secTensEl) secTensEl.textContent = time.secTens;
            if (secOnesEl) secOnesEl.textContent = time.secOnes;
        }

        // Show notification
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23b8d4f1"/></svg>',
                    requireInteraction: false
                });
            }
        }

        // Timer tick
        function tick() {
            const now = Date.now();
            remainingSeconds = Math.max(0, Math.ceil((endTime - now) / 1000));
            updateDisplay();

            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                isRunning = false;

                if (currentMode === 'pomodoro') {
                    if (isWorkSession) {
                        // Work session completed - show completion ceremony
                        showNotification('Work Complete!', 'Great job! Ready for a 5-minute break?');

                        // Increment session count when work session completes
                        sessionCount++;
                        if (sessionCountEl) sessionCountEl.textContent = sessionCount;
                        recordSession('pomodoro');

                        // Update river data first
                        if (typeof updateRiverSegment === 'function') {
                            updateRiverSegment();
                        }

                        // Show completion ceremony, then reveal rest button
                        if (typeof showCompletionCeremony === 'function') {
                            showCompletionCeremony();
                            // Delay showing rest button until ceremony fades
                            setTimeout(() => {
                                if (restButton) restButton.classList.remove('hide');
                                if (stopButton) stopButton.classList.remove('visible');
                                // Update mini river
                                if (typeof renderMiniRiver === 'function') {
                                    renderMiniRiver();
                                }
                            }, 2600);
                        } else {
                            restButton.classList.remove('hide');
                            stopButton.classList.remove('visible');
                        }

                        // Keep session context visible during rest
                        // Update adaptive UI
                        if (typeof updateAdaptiveUI === 'function') {
                            updateAdaptiveUI();
                        }
                    } else {
                        // Rest session completed - reset to duration selection
                        showNotification('Rest Complete!', 'Ready for another work session?');

                        // Reset to initial state (duration selection)
                        isWorkSession = true;
                        remainingSeconds = workDuration * 60;

                        const timeOfDay = getTimeOfDay();
                        sessionLabelEl.textContent = 'Work';
                        backgroundEl.className = `background work ${timeOfDay}`;

                        updateDisplay();

                        // Exit focus mode
                        appContainer.classList.remove('timer-focus-mode');

                        // Show duration selector and start button (not work button)
                        hideSessionContext();
                        startButton.classList.remove('hide');
                        durationSelector.classList.remove('hide');
                        workButton.classList.add('hide');
                        stopButton.classList.remove('visible');

                        // Update adaptive UI
                        if (typeof updateAdaptiveUI === 'function') {
                            updateAdaptiveUI();
                        }
                    }
                } else {
                    // YouTube Creator mode - session completed
                    if (!sessionRecorded) {
                        sessionRecorded = true;
                        sessionCount++;
                        if (sessionCountEl) sessionCountEl.textContent = sessionCount;
                        recordSession('youtube', youtubePhase);
                    }

                    // Get current phase label for notification
                    const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
                    const phaseLabel = currentPhase ? currentPhase.label : youtubePhase;
                    showNotification('Session Complete!', `${phaseLabel} session recorded!`);

                    // Update river data
                    if (typeof updateRiverSegment === 'function') {
                        updateRiverSegment();
                    }

                    // Show completion ceremony
                    if (typeof showCompletionCeremony === 'function') {
                        showCompletionCeremony();
                    }

                    // Reset to ready state
                    sessionLabelEl.textContent = phaseLabel;
                    sessionLabelEl.classList.remove('breathing');
                    backgroundEl.className = 'background youtube-editing';
                    remainingSeconds = YOUTUBE_SESSION_DURATION;
                    updateDisplay();

                    // Exit focus mode
                    appContainer.classList.remove('timer-focus-mode');

                    // Show session setup and start button
                    sessionSetup.classList.remove('hide');
                    hideSessionContext();
                    startYoutubeBtn.classList.remove('hide');
                    stopButton.classList.remove('visible');
                    // Update adaptive UI
                    if (typeof updateAdaptiveUI === 'function') {
                        updateAdaptiveUI();
                    }
                }
            }
        }

        // Start timer
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startButton.classList.add('hide');
                durationSelector.classList.add('hide');
                stopButton.classList.add('visible');
                restButton.classList.add('hide');

                // Enter focus mode
                appContainer.classList.add('timer-focus-mode');
                appContainer.classList.remove('has-expanded');
                expandedSection = null;

                // Hide priorities/gratitude panels during timer
                if (typeof updateAdaptiveUI === 'function') {
                    updateAdaptiveUI();
                }

                // Add breathing animation during work sessions
                if (isWorkSession) {
                    sessionLabelEl.classList.add('breathing');
                }

                endTime = Date.now() + (remainingSeconds * 1000);
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(tick, 1000);
            }
        }

        // Start rest timer
        function startRestTimer() {
            isWorkSession = false;
            remainingSeconds = 5 * 60;

            const timeOfDay = getTimeOfDay();
            sessionLabelEl.textContent = 'Rest';
            backgroundEl.className = `background rest ${timeOfDay}`;
            sessionLabelEl.classList.remove('breathing');

            updateDisplay();

            // Hide rest button and setup UI, show stop button
            restButton.classList.add('hide');
            sessionSetup.classList.add('hide');
            stopButton.classList.add('visible');

            // Enter/stay in focus mode
            appContainer.classList.add('timer-focus-mode');
            appContainer.classList.remove('has-expanded');
            expandedSection = null;

            // Hide priorities/gratitude panels during timer
            if (typeof updateAdaptiveUI === 'function') {
                updateAdaptiveUI();
            }

            // Keep session context visible during rest

            // Start the timer
            isRunning = true;
            endTime = Date.now() + (remainingSeconds * 1000);
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
        }

        // Start work timer (after rest is complete)
        function startWorkTimer() {
            // Set up work session
            isWorkSession = true;
            remainingSeconds = workDuration * 60;

            const timeOfDay = getTimeOfDay();
            sessionLabelEl.textContent = 'Work';
            backgroundEl.className = `background work ${timeOfDay}`;
            sessionLabelEl.classList.add('breathing');

            updateDisplay();

            // Hide work button and setup UI, show stop button
            workButton.classList.add('hide');
            sessionSetup.classList.add('hide');
            stopButton.classList.add('visible');
            restButton.classList.add('hide');

            // Enter/stay in focus mode
            appContainer.classList.add('timer-focus-mode');
            appContainer.classList.remove('has-expanded');
            expandedSection = null;

            // Hide priorities/gratitude panels during timer
            if (typeof updateAdaptiveUI === 'function') {
                updateAdaptiveUI();
            }

            // Show session context (only for Quinlan mode)
            if (currentMode === 'youtube') {
                showSessionContext();
            }

            // Start the timer
            isRunning = true;
            endTime = Date.now() + (remainingSeconds * 1000);
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
        }

        // Stop/Reset timer
        function stopTimer() {
            clearInterval(timerInterval);
            isRunning = false;

            // Exit focus mode
            appContainer.classList.remove('timer-focus-mode');

            // Load today's session count from storage (don't reset to 0)
            sessionCount = getTodaySessionCount();
            if (sessionCountEl) sessionCountEl.textContent = sessionCount;

            // Remove breathing animation when stopped
            sessionLabelEl.classList.remove('breathing');

            // Show session setup (only for Quinlan mode)
            if (currentMode === 'youtube') {
                sessionSetup.classList.remove('hide');
            }

            if (currentMode === 'pomodoro') {
                isWorkSession = true;
                remainingSeconds = workDuration * 60;

                const timeOfDay = getTimeOfDay();
                sessionLabelEl.textContent = 'Work';
                backgroundEl.className = `background work ${timeOfDay}`;

                updateDisplay();

                startButton.classList.remove('hide');
                durationSelector.classList.remove('hide');
                restButton.classList.add('hide');
                workButton.classList.add('hide');
            } else {
                // YouTube Creator mode reset
                youtubePhase = phaseSelect.value || 'idea';
                remainingSeconds = YOUTUBE_SESSION_DURATION;
                const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
                sessionLabelEl.textContent = currentPhase ? currentPhase.label : youtubePhase;
                backgroundEl.className = 'background youtube-editing';

                updateDisplay();

                startYoutubeBtn.classList.remove('hide');
            }

            stopButton.classList.remove('visible');

            // Update adaptive UI for priorities/gratitude panels
            if (typeof updateAdaptiveUI === 'function') {
                updateAdaptiveUI();
            }
        }

        // YouTube: Start session timer
        function startYoutubeTimer() {
            if (!isRunning) {
                sessionRecorded = false;  // Reset guard flag
                isRunning = true;
                youtubePhase = phaseSelect.value || 'idea';
                remainingSeconds = YOUTUBE_SESSION_DURATION;

                const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
                const phaseLabel = currentPhase ? currentPhase.label : youtubePhase;
                sessionLabelEl.textContent = phaseLabel;
                backgroundEl.className = 'background youtube-editing';
                sessionLabelEl.classList.add('breathing');

                updateDisplay();

                startYoutubeBtn.classList.add('hide');
                stopButton.classList.add('visible');

                // Enter focus mode
                appContainer.classList.add('timer-focus-mode');
                appContainer.classList.remove('has-expanded');
                expandedSection = null;

                // Hide priorities/gratitude panels during timer
                if (typeof updateAdaptiveUI === 'function') {
                    updateAdaptiveUI();
                }

                endTime = Date.now() + (remainingSeconds * 1000);
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(tick, 1000);
            }
        }

        // Switch between modes
        function switchMode(mode) {
            if (mode === currentMode) return;

            // Stop any running timer
            clearInterval(timerInterval);
            isRunning = false;
            sessionRecorded = false;  // Reset guard flag
            sessionLabelEl.classList.remove('breathing');

            // Exit focus mode
            appContainer.classList.remove('timer-focus-mode');

            // Update mode state
            currentMode = mode;

            // Load today's session count for the new mode from storage
            sessionCount = getTodaySessionCount();
            if (sessionCountEl) sessionCountEl.textContent = sessionCount;

            // Update all mode switcher UIs (collapsed and expanded)
            allModeOptions.forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.mode === mode);
            });

            // Update all slider positions and widths dynamically
            document.querySelectorAll('.mode-switcher').forEach(switcher => {
                const slider = switcher.querySelector('.mode-slider');
                const selectedOption = switcher.querySelector(`.mode-option[data-mode="${mode}"]`);
                if (slider && selectedOption) {
                    const sliderWidth = selectedOption.offsetWidth;
                    const sliderLeft = selectedOption.offsetLeft - 4; // Account for container padding
                    slider.style.width = sliderWidth + 'px';
                    slider.style.transform = `translateX(${sliderLeft}px)`;
                }
            });

            // Hide all buttons first
            startButton.classList.add('hide');
            restButton.classList.add('hide');
            workButton.classList.add('hide');
            startYoutubeBtn.classList.add('hide');
            stopButton.classList.remove('visible');

            if (mode === 'pomodoro') {
                // Switch to Pomodoro mode
                isWorkSession = true;
                remainingSeconds = workDuration * 60;

                const timeOfDay = getTimeOfDay();
                sessionLabelEl.textContent = 'Work';
                backgroundEl.className = `background work ${timeOfDay}`;

                durationSelector.classList.remove('hide');
                startButton.classList.remove('hide');
                sessionSetup.classList.add('hide');
            } else {
                // Switch to YouTube Creator mode
                youtubePhase = phaseSelect.value || 'idea';
                remainingSeconds = YOUTUBE_SESSION_DURATION;

                const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
                sessionLabelEl.textContent = currentPhase ? currentPhase.label : youtubePhase;
                backgroundEl.className = 'background youtube-editing';

                durationSelector.classList.add('hide');
                startYoutubeBtn.classList.remove('hide');
                sessionSetup.classList.remove('hide');
            }

            updateDisplay();

            // Update adaptive UI for priorities/gratitude panels
            if (typeof updateAdaptiveUI === 'function') {
                updateAdaptiveUI();
            }
        }

        // ==========================================
        // PROJECT MANAGEMENT
        // ==========================================

        // Load projects from localStorage
        function loadProjects() {
            return projectStorage.load();
        }

        // Save projects to localStorage
        function saveProjects(data) {
            return projectStorage.save(data);
        }

        // Add a project to the list (most recent first)
        function addProject(projectName) {
            if (!projectName || projectName.trim() === '') return;

            const data = loadProjects();
            const modeKey = currentMode === 'pomodoro' ? 'work' : 'quinlan';

            // Remove if already exists (to move to front)
            const index = data.projects[modeKey].indexOf(projectName);
            if (index > -1) {
                data.projects[modeKey].splice(index, 1);
            }

            // Add to front
            data.projects[modeKey].unshift(projectName);

            // Keep max 10 projects per mode
            if (data.projects[modeKey].length > 10) {
                data.projects[modeKey] = data.projects[modeKey].slice(0, 10);
            }

            saveProjects(data);
        }

        // Get projects for current mode
        function getProjects() {
            const data = loadProjects();
            const modeKey = currentMode === 'pomodoro' ? 'work' : 'quinlan';
            return data.projects[modeKey] || [];
        }

        // Save intro line for a project
        function saveIntroLine(projectName, introLine) {
            if (!projectName) return;
            const data = loadProjects();
            data.introLines[projectName] = introLine;
            saveProjects(data);
        }

        // Get intro line for a project
        function getIntroLine(projectName) {
            if (!projectName) return '';
            const data = loadProjects();
            return data.introLines[projectName] || '';
        }

        // Update project dropdown
        function updateProjectDropdown(filter = '') {
            const projects = getProjects();
            const filterLower = filter.toLowerCase();

            let html = '';

            // Filter projects
            const filtered = projects.filter(p =>
                p.toLowerCase().includes(filterLower)
            );

            // Show filtered projects
            filtered.forEach(project => {
                html += `<div class="project-option" data-project="${project}">${project}</div>`;
            });

            // Show create new option if filter has text and doesn't match existing
            if (filter.trim() && !projects.includes(filter.trim())) {
                html += `<div class="project-option create-new" data-project="${filter.trim()}">Create "${filter.trim()}"</div>`;
            }

            projectDropdown.innerHTML = html;
            // Note: Click handlers use event delegation (set up once below)
        }

        // Set up event delegation for project dropdown (prevents listener accumulation)
        if (projectDropdown) {
            projectDropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.project-option');
                if (option) {
                    selectProject(option.dataset.project);
                }
            });
        }

        // Select a project
        function selectProject(projectName) {
            currentProject = projectName;
            projectInput.value = projectName;
            projectDropdown.classList.remove('show');

            // Show saved intro preview if exists (only for Quinlan mode)
            if (currentMode === 'youtube') {
                const savedIntro = getIntroLine(projectName);
                if (savedIntro) {
                    savedIntroText.textContent = `"${savedIntro.substring(0, 50)}${savedIntro.length > 50 ? '...' : ''}"`;
                    savedIntroPreview.classList.add('show');
                } else {
                    savedIntroPreview.classList.remove('show');
                }
            } else {
                savedIntroPreview.classList.remove('show');
            }
        }

        // Show session context during timer
        function showSessionContext() {
            if (currentProject || (currentMode === 'youtube' && youtubePhase)) {
                if (currentProject) {
                    contextModeProject.textContent = currentProject;
                } else {
                    contextModeProject.textContent = '';
                }

                if (currentMode === 'youtube' && youtubePhase) {
                    const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
                    contextPhase.textContent = currentPhase ? currentPhase.label : '';
                } else {
                    contextPhase.textContent = '';
                }

                sessionContext.classList.add('visible');
            }
        }

        // Hide session context
        function hideSessionContext() {
            sessionContext.classList.remove('visible');
        }

        // Event listeners
        startButton.addEventListener('click', () => {
            // Save project if entered (for Work mode, not used but kept for consistency)
            if (currentProject) {
                addProject(currentProject);
            }

            // Hide setup UI when starting
            sessionSetup.classList.add('hide');

            startTimer();
        });
        restButton.addEventListener('click', startRestTimer);
        workButton.addEventListener('click', startWorkTimer);
        stopButton.addEventListener('click', () => {
            hideSessionContext();
            stopTimer();
        });
        startYoutubeBtn.addEventListener('click', () => {
            // Save project if entered
            if (currentProject) {
                addProject(currentProject);
            }

            // Hide setup UI when starting
            sessionSetup.classList.add('hide');

            // Show session context
            showSessionContext();

            startYoutubeTimer();
        });

        // Mode switcher click handlers (works on all mode switchers)
        allModeOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation(); // Don't trigger section expand
                switchMode(option.dataset.mode);
                // Clear project selection when switching modes
                currentProject = '';
                projectInput.value = '';
                savedIntroPreview.classList.remove('show');
                updateProjectDropdown('');
            });
        });

        // Duration selector click handlers
        durationOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Update selected state
                durationOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');

                // Update work duration
                workDuration = parseInt(option.dataset.duration);
                remainingSeconds = workDuration * 60;
                updateDisplay();
            });
        });

        // Project input handlers
        projectInput.addEventListener('focus', () => {
            updateProjectDropdown(projectInput.value);
            projectDropdown.classList.add('show');
        });

        projectInput.addEventListener('input', () => {
            currentProject = projectInput.value;
            updateProjectDropdown(projectInput.value);
            projectDropdown.classList.add('show');
            savedIntroPreview.classList.remove('show');
        });

        projectInput.addEventListener('blur', () => {
            // Delay to allow clicking on dropdown
            setTimeout(() => {
                projectDropdown.classList.remove('show');
            }, 200);
        });

        projectInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (projectInput.value.trim()) {
                    selectProject(projectInput.value.trim());
                }
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.project-input-wrapper')) {
                projectDropdown.classList.remove('show');
            }
        });

        // Check for time of day changes every minute (only for Pomodoro mode)
        setInterval(() => {
            if (isRunning && currentMode === 'pomodoro') {
                const currentTimeOfDay = getTimeOfDay();
                const backgroundClasses = backgroundEl.className.split(' ');
                const oldTimeOfDay = backgroundClasses[2];

                if (oldTimeOfDay !== currentTimeOfDay) {
                    // Time of day changed, update background
                    const sessionType = isWorkSession ? 'work' : 'rest';
                    backgroundEl.className = `background ${sessionType} ${currentTimeOfDay}`;
                }
            }
        }, 60000); // Check every minute

        // Initialize display
        updateDisplay();

        // Set initial time-of-day palette
        backgroundEl.className = `background work ${getTimeOfDay()}`;

        // Hide session setup by default (starts in Work mode)
        sessionSetup.classList.add('hide');

        // Initialize phase selector
        function initPhaseSelector() {
            phaseSelect.innerHTML = VIDEO_PHASES.map(phase =>
                `<option value="${phase.id}">${phase.label}</option>`
            ).join('');
            youtubePhase = phaseSelect.value;
        }
        initPhaseSelector();

        // Update session label when phase changes
        phaseSelect.addEventListener('change', () => {
            youtubePhase = phaseSelect.value;
            const currentPhase = VIDEO_PHASES.find(p => p.id === youtubePhase);
            if (currentPhase && !isRunning) {
                sessionLabelEl.textContent = currentPhase.label;
            }
        });

        // ==========================================
        // PRIORITIES & GRATITUDE
        // ==========================================

        const PRIORITIES_STORAGE_KEY = 'pomodoro_priorities';
        const GRATITUDE_STORAGE_KEY = 'pomodoro_gratitude';
        const RIVER_STORAGE_KEY = 'pomodoro_river';

        // ==========================================
        // UNIFIED STORAGE MANAGER
        // ==========================================

        // Show storage error feedback to user
        let storageErrorShown = false;
        function showStorageError() {
            if (storageErrorShown) return; // Prevent spam
            storageErrorShown = true;
            console.error('Unable to save data. Storage may be full or unavailable.');
            // Reset after 5 seconds to allow showing again if needed
            setTimeout(() => { storageErrorShown = false; }, 5000);
        }

        function createStorage(key, defaults) {
            return {
                load() {
                    try {
                        const stored = localStorage.getItem(key);
                        if (!stored) return { ...defaults };
                        return { ...defaults, ...JSON.parse(stored) };
                    } catch (e) {
                        console.warn(`Storage load failed [${key}]:`, e);
                        return { ...defaults };
                    }
                },
                save(data) {
                    try {
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.warn(`Storage save failed [${key}]:`, e);
                        showStorageError();
                        return false;
                    }
                }
            };
        }

        // Storage instances (session storage added later after STORAGE_KEY is defined)
        const projectStorage = createStorage(PROJECTS_STORAGE_KEY, { version: 1, projects: { work: [], quinlan: [] }, introLines: {}, projectSessions: {} });
        const priorityStorage = createStorage(PRIORITIES_STORAGE_KEY, { version: 1, days: {}, stats: { totalDaysSet: 0, totalCompleted: 0, currentStreak: 0 } });
        const gratitudeStorage = createStorage(GRATITUDE_STORAGE_KEY, { version: 1, entries: {}, stats: { totalDaysRecorded: 0, currentStreak: 0 } });
        const riverStorage = createStorage(RIVER_STORAGE_KEY, { version: 1, segments: [] });
        // Note: sessionDataStorage is created later after STORAGE_KEY is defined

        // Input array factory - creates arrays of DOM elements with null filtering
        function getInputArray(prefix, count) {
            return Array.from({ length: count }, (_, i) =>
                document.getElementById(`${prefix}-${i + 1}`)
            ).filter(Boolean);
        }

        // DOM elements for priorities and gratitude (now in section cards)
        const priorityInputs = getInputArray('priority', 3);
        const setPrioritiesBtn = document.querySelector('.set-priorities-btn');

        const gratitudeInputs = getInputArray('gratitude', 3);
        const saveGratitudeBtn = document.querySelector('.save-gratitude-btn');

        // Session-level flag for gratitude dismissal
        let gratitudeDismissedThisSession = false;

        // Load priorities data from localStorage
        function loadPriorities() {
            return priorityStorage.load();
        }

        // Save priorities data to localStorage
        function savePriorities(data) {
            return priorityStorage.save(data);
        }

        // Get today's priorities
        function getTodayPriorities() {
            const data = loadPriorities();
            const today = getTodayDateKey();
            return data.days[today] || null;
        }

        // Set today's priorities
        function setTodayPriorities(priorities) {
            const data = loadPriorities();
            const today = getTodayDateKey();

            // Check if this is a new day (for stats)
            const isNewDay = !data.days[today];

            data.days[today] = {
                priorities: priorities.map(text => ({
                    text: text,
                    completed: false,
                    completedAt: null
                })),
                setAt: new Date().toISOString()
            };

            // Update stats
            if (isNewDay) {
                data.stats.totalDaysSet++;
                updatePriorityStreak(data);
            }

            savePriorities(data);
        }

        // Toggle priority completion
        function togglePriorityCompletion(index) {
            const data = loadPriorities();
            const today = getTodayDateKey();

            if (!data.days[today] || !data.days[today].priorities[index]) return;

            const priority = data.days[today].priorities[index];
            const wasCompleted = priority.completed;
            priority.completed = !priority.completed;
            priority.completedAt = priority.completed ? new Date().toISOString() : null;

            // Update total completed stat
            if (priority.completed && !wasCompleted) {
                data.stats.totalCompleted++;
            } else if (!priority.completed && wasCompleted) {
                data.stats.totalCompleted--;
            }

            savePriorities(data);
            renderCompactPriorities();
            updatePrioritiesCollapsedPreview();

            // Update river with new completion status
            if (typeof updateRiverSegment === 'function') {
                updateRiverSegment();
                if (typeof renderMiniRiver === 'function') {
                    renderMiniRiver();
                }
            }
        }

        // Update priority streak
        function updatePriorityStreak(data) {
            const dates = Object.keys(data.days).sort().reverse();
            let streak = 0;
            const today = getTodayDateKey();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toLocaleDateString('sv');

            // Start checking from today or yesterday
            let checkDate = data.days[today] ? today : yesterdayKey;

            for (const date of dates) {
                if (date === checkDate) {
                    streak++;
                    const prevDate = new Date(checkDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    checkDate = prevDate.toLocaleDateString('sv');
                } else if (date < checkDate) {
                    break;
                }
            }

            data.stats.currentStreak = streak;
        }

        // Calculate priority completion stats for current week
        function getWeeklyPriorityStats() {
            const data = loadPriorities();
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)

            let completed = 0;
            let total = 0;

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateKey = date.toLocaleDateString('sv');

                if (data.days[dateKey]) {
                    const dayData = data.days[dateKey];
                    total += dayData.priorities.length;
                    completed += dayData.priorities.filter(p => p.completed).length;
                }
            }

            return { completed, total, percentage: total > 0 ? Math.round((completed / total) * 100) : 0 };
        }

        // Load gratitude data from localStorage
        function loadGratitude() {
            return gratitudeStorage.load();
        }

        // Save gratitude data to localStorage
        function saveGratitude(data) {
            return gratitudeStorage.save(data);
        }

        // Get today's gratitude
        function getTodayGratitude() {
            const data = loadGratitude();
            const today = getTodayDateKey();
            return data.entries[today] || null;
        }

        // Populate gratitude inputs when expanding the gratitude card
        function populateGratitudeInputs() {
            const todayData = getTodayGratitude();
            if (todayData && todayData.items) {
                // Populate inputs with saved data
                todayData.items.forEach((item, index) => {
                    if (gratitudeInputs[index]) {
                        gratitudeInputs[index].value = item;
                    }
                });
            } else {
                // Clear inputs if no saved data
                gratitudeInputs.forEach(input => {
                    input.value = '';
                });
            }
        }

        // Save today's gratitude
        function saveTodayGratitude(items) {
            const data = loadGratitude();
            const today = getTodayDateKey();

            // Check if this is a new day (for stats)
            const isNewDay = !data.entries[today];

            data.entries[today] = {
                items: items,
                savedAt: new Date().toISOString()
            };

            // Update stats
            if (isNewDay) {
                data.stats.totalDaysRecorded++;
                updateGratitudeStreak(data);
            }

            saveGratitude(data);
        }

        // Update gratitude streak
        function updateGratitudeStreak(data) {
            const dates = Object.keys(data.entries).sort().reverse();
            let streak = 0;
            const today = getTodayDateKey();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toLocaleDateString('sv');

            // Start checking from today or yesterday
            let checkDate = data.entries[today] ? today : yesterdayKey;

            for (const date of dates) {
                if (date === checkDate) {
                    streak++;
                    const prevDate = new Date(checkDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    checkDate = prevDate.toLocaleDateString('sv');
                } else if (date < checkDate) {
                    break;
                }
            }

            data.stats.currentStreak = streak;
        }

        // Render compact priority checklist
        function renderCompactPriorities() {
            const todayData = getTodayPriorities();
            if (!todayData) return;

            priorityChecklist.innerHTML = todayData.priorities.map((p, i) => `
                <div class="priority-check-item ${p.completed ? 'completed' : ''}" data-index="${i}">
                    <div class="priority-checkbox ${p.completed ? 'checked' : ''}"></div>
                    <span class="priority-check-text" title="${p.text}">${p.text}</span>
                </div>
            `).join('');

            // Add click handlers
            priorityChecklist.querySelectorAll('.priority-check-item').forEach(item => {
                item.addEventListener('click', () => {
                    togglePriorityCompletion(parseInt(item.dataset.index));
                });
            });
        }

        // Determine and show the appropriate adaptive UI state
        function updateAdaptiveUI() {
            // Update all collapsed previews
            updatePrioritiesCollapsedPreview();
            updateTimerCollapsedPreview();
            updateGratitudeCollapsedPreview();
            updateTimeOfDayEmphasis();

            // Auto-expand logic for prompts
            if (!expandedSection && !isRunning) {
                const timeOfDay = getTimeOfDay();
                const todayPriorities = getTodayPriorities();
                const todayGratitude = getTodayGratitude();

                // In evening, if gratitude not recorded, auto-expand gratitude
                if (timeOfDay === 'evening' && !todayGratitude && !gratitudeDismissedThisSession) {
                    // Don't auto-expand, just let the time-emphasis highlight it
                }

                // If priorities not set, auto-expand priorities in morning
                if (!todayPriorities && timeOfDay === 'morning') {
                    // Don't auto-expand, just let the time-emphasis highlight it
                }
            }
        }

        // Set priorities button handler
        setPrioritiesBtn.addEventListener('click', () => {
            const newPriorities = priorityInputs.map(input => input.value.trim());

            if (newPriorities.filter(text => text).length < 3) {
                // Need all 3 priorities
                priorityInputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.style.borderColor = 'rgba(200, 100, 100, 0.5)';
                        setTimeout(() => {
                            input.style.borderColor = '';
                        }, 2000);
                    }
                });
                return;
            }

            // Check if editing existing priorities - preserve completion status
            const existingData = getTodayPriorities();
            if (existingData) {
                // Update existing priorities, preserving completion if text matches
                const data = loadPriorities();
                const today = getTodayDateKey();

                data.days[today].priorities = newPriorities.map((text, i) => {
                    const existing = existingData.priorities[i];
                    // Preserve completion only if text is the same
                    const sameText = existing && existing.text === text;
                    return {
                        text: text,
                        completed: sameText ? existing.completed : false,
                        completedAt: sameText ? existing.completedAt : null
                    };
                });

                savePriorities(data);
            } else {
                // Creating new priorities
                setTodayPriorities(newPriorities);
            }

            // Update river with priorities status
            if (typeof updateRiverSegment === 'function') {
                updateRiverSegment();
                if (typeof renderMiniRiver === 'function') {
                    renderMiniRiver();
                }
            }

            // Show save feedback
            showSaveFeedback(setPrioritiesBtn, 'Set Priorities');

            // Switch to complete mode and update collapsed preview
            updateExpandedPrioritiesView();
            updatePrioritiesCollapsedPreview();
        });

        // Edit priorities button handler
        const editPrioritiesBtn = document.querySelector('.edit-priorities-btn');
        if (editPrioritiesBtn) {
            editPrioritiesBtn.addEventListener('click', () => {
                switchToEditMode();
            });
        }

        // Save gratitude button handler
        saveGratitudeBtn.addEventListener('click', () => {
            const items = gratitudeInputs.map(input => input.value.trim()).filter(text => text);

            if (items.length === 0) {
                // Need at least one item
                gratitudeInputs[0].style.borderColor = 'rgba(200, 100, 100, 0.5)';
                setTimeout(() => {
                    gratitudeInputs[0].style.borderColor = '';
                }, 2000);
                return;
            }

            saveTodayGratitude(items);

            // Update river with gratitude status
            if (typeof updateRiverSegment === 'function') {
                updateRiverSegment();
                renderMiniRiver();
            }

            // Show save feedback then collapse
            showSaveFeedback(saveGratitudeBtn, 'Save Gratitude');
            setTimeout(() => {
                collapseAllSections();
            }, 800);
        });

        // Initialize three-panel layout
        setupSectionClickHandlers();
        updateAdaptiveUI();

        // Initialize mode slider positions based on current mode
        function initializeModeSliders() {
            document.querySelectorAll('.mode-switcher').forEach(switcher => {
                const slider = switcher.querySelector('.mode-slider');
                const selectedOption = switcher.querySelector('.mode-option.selected');
                if (slider && selectedOption) {
                    const sliderWidth = selectedOption.offsetWidth;
                    const sliderLeft = selectedOption.offsetLeft - 4; // Account for container padding
                    slider.style.width = sliderWidth + 'px';
                    slider.style.transform = `translateX(${sliderLeft}px)`;
                }
            });
        }
        initializeModeSliders();
        // Re-initialize sliders on window resize
        window.addEventListener('resize', initializeModeSliders);

        // ==========================================
        // SESSION TRACKING & STORAGE
        // ==========================================

        const STORAGE_KEY = 'pomodoro_session_data';
        const DATA_VERSION = 1;

        // Session data storage instance
        const sessionDataStorage = createStorage(STORAGE_KEY, { version: DATA_VERSION, sessions: {} });

        // Dashboard DOM elements
        const dashboardBtn = document.querySelector('.dashboard-btn');
        const dashboardView = document.querySelector('.dashboard-view');
        const dashboardBackBtn = document.querySelector('.dashboard-back-btn');
        const timerContainer = document.querySelector('.timer-container');
        const sessionCounter = document.querySelector('.session-counter');
        const viewOptions = document.querySelectorAll('.view-option');
        const daysActiveEl = document.getElementById('days-active');
        const todaySessionsEl = document.getElementById('today-sessions');
        const totalSessionsEl = document.getElementById('total-sessions');
        const sessionChart = document.getElementById('session-chart');
        const chartEmptyMessage = document.querySelector('.chart-empty-message');
        const clearDataBtn = document.querySelector('.clear-data-btn');
        const projectSummary = document.getElementById('project-summary');
        const projectList = document.getElementById('project-list');

        // New dashboard elements for priorities and gratitude
        const prioritiesDashboard = document.getElementById('priorities-dashboard');
        const prioritiesHistory = document.getElementById('priorities-history');
        const weekPriorityStats = document.getElementById('week-priority-stats');
        const gratitudeDashboard = document.getElementById('gratitude-dashboard');
        const gratitudeJournal = document.getElementById('gratitude-journal');
        const gratitudeStreakBadge = document.getElementById('gratitude-streak-badge');
        const statPriority = document.getElementById('stat-priority');
        const statGratitude = document.getElementById('stat-gratitude');
        const priorityPercentEl = document.getElementById('priority-percent');
        const gratitudeStreakEl = document.getElementById('gratitude-streak');
        const chartContainer = document.querySelector('.chart-container');

        let currentViewMode = 'combined'; // 'combined', 'pomodoro', 'youtube', 'priorities', 'gratitude'

        // Get today's date key in YYYY-MM-DD format
        function getTodayDateKey() {
            return new Date().toLocaleDateString('sv'); // Swedish locale gives ISO format
        }

        // Load session data from localStorage
        function loadSessionData() {
            return sessionDataStorage.load();
        }

        // Save session data to localStorage
        function saveSessionData(data) {
            return sessionDataStorage.save(data);
        }

        // Helper to get youtube session total (handles old and new data formats)
        // New format: { "projectName": { phaseId: N, ... }, ... }
        // Old formats: number OR { edit: N, intro: N }
        function getYoutubeTotal(youtube) {
            if (typeof youtube !== 'object' || youtube === null) {
                return youtube || 0; // Old number format
            }
            // Check if it's old { edit, intro } format or new { projectName: { phases } } format
            if ('edit' in youtube || 'intro' in youtube) {
                return (youtube.edit || 0) + (youtube.intro || 0); // Old object format
            }
            // New format: sum across all projects and all phases
            let total = 0;
            for (const projectData of Object.values(youtube)) {
                if (typeof projectData === 'object' && projectData !== null) {
                    for (const count of Object.values(projectData)) {
                        total += count || 0;
                    }
                }
            }
            return total;
        }

        // Helper to get project session totals with phase breakdown from all session data
        // Returns: { projectName: { total: N, phases: { phaseId: N, ... } }, ... }
        function getProjectSessionTotals() {
            const data = loadSessionData();
            const totals = {};

            for (const dayData of Object.values(data.sessions)) {
                const youtube = dayData.youtube;
                if (typeof youtube !== 'object' || youtube === null) continue;
                // Skip old { edit, intro } format - can't determine project
                if ('edit' in youtube || 'intro' in youtube) continue;

                // New format: iterate through projects
                for (const [projectName, projectData] of Object.entries(youtube)) {
                    if (typeof projectData === 'object' && projectData !== null) {
                        if (!totals[projectName]) {
                            totals[projectName] = { total: 0, phases: {} };
                        }
                        // Sum all phases for this project
                        for (const [phaseId, count] of Object.entries(projectData)) {
                            const phaseCount = count || 0;
                            totals[projectName].total += phaseCount;
                            if (!totals[projectName].phases[phaseId]) {
                                totals[projectName].phases[phaseId] = 0;
                            }
                            totals[projectName].phases[phaseId] += phaseCount;
                        }
                    }
                }
            }
            return totals;
        }

        // Record a completed session
        function recordSession(mode, phaseId = 'edit') {
            const data = loadSessionData();
            const today = getTodayDateKey();

            if (!data.sessions[today]) {
                data.sessions[today] = { pomodoro: 0, youtube: {} };
            }

            if (mode === 'pomodoro') {
                data.sessions[today].pomodoro++;
            } else if (mode === 'youtube') {
                // Migrate old formats to new format if needed
                const yt = data.sessions[today].youtube;
                if (typeof yt !== 'object' || yt === null) {
                    // Old number format - migrate to new format (assign to _unassigned)
                    const oldCount = yt || 0;
                    data.sessions[today].youtube = oldCount > 0
                        ? { '_unassigned': { edit: oldCount } }
                        : {};
                } else if ('edit' in yt || 'intro' in yt) {
                    // Old { edit, intro } format - migrate to new format
                    const oldEdit = yt.edit || 0;
                    const oldIntro = yt.intro || 0;
                    const migrated = {};
                    if (oldEdit > 0) migrated.edit = oldEdit;
                    if (oldIntro > 0) migrated.intro = oldIntro;
                    data.sessions[today].youtube = Object.keys(migrated).length > 0
                        ? { '_unassigned': migrated }
                        : {};
                }

                // Record session under current project (or _unassigned if none)
                const projectKey = currentProject || '_unassigned';
                if (!data.sessions[today].youtube[projectKey]) {
                    data.sessions[today].youtube[projectKey] = {};
                }
                if (!data.sessions[today].youtube[projectKey][phaseId]) {
                    data.sessions[today].youtube[projectKey][phaseId] = 0;
                }
                data.sessions[today].youtube[projectKey][phaseId]++;
            }

            saveSessionData(data);
        }

        // Get sessions for a date range (returns array of { date, pomodoro, youtube })
        function getSessionsForDateRange(startDate, endDate) {
            const data = loadSessionData();
            const sessions = [];
            const current = new Date(startDate);
            const end = new Date(endDate);

            while (current <= end) {
                const dateKey = current.toLocaleDateString('sv');
                const dayData = data.sessions[dateKey] || { pomodoro: 0, youtube: { edit: 0, intro: 0 } };
                sessions.push({
                    date: dateKey,
                    pomodoro: dayData.pomodoro,
                    youtube: getYoutubeTotal(dayData.youtube)
                });
                current.setDate(current.getDate() + 1);
            }

            return sessions;
        }

        // Calculate stats from session data
        function calculateStats(viewMode) {
            const data = loadSessionData();
            const today = getTodayDateKey();

            let daysActive = 0;
            let todaySessions = 0;
            let totalSessions = 0;

            for (const [date, dayData] of Object.entries(data.sessions)) {
                let dayTotal = 0;
                const youtubeTotal = getYoutubeTotal(dayData.youtube);

                if (viewMode === 'combined') {
                    dayTotal = dayData.pomodoro + youtubeTotal;
                } else if (viewMode === 'pomodoro') {
                    dayTotal = dayData.pomodoro;
                } else if (viewMode === 'youtube') {
                    dayTotal = youtubeTotal;
                }

                if (dayTotal > 0) {
                    daysActive++;
                    totalSessions += dayTotal;

                    if (date === today) {
                        todaySessions = dayTotal;
                    }
                }
            }

            return { daysActive, todaySessions, totalSessions };
        }

        // Get today's session count for in-page counter
        function getTodaySessionCount() {
            const data = loadSessionData();
            const today = getTodayDateKey();
            const dayData = data.sessions[today];

            if (!dayData) return 0;

            if (currentMode === 'pomodoro') {
                return dayData.pomodoro;
            } else {
                return getYoutubeTotal(dayData.youtube);
            }
        }

        // Clear all session data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all session data? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                sessionCount = 0;
                sessionCountEl.textContent = sessionCount;
                renderDashboard();
            }
        }

        // ==========================================
        // CHART RENDERING
        // ==========================================

        function renderChart(viewMode) {
            const svg = sessionChart;
            const container = document.querySelector('.chart-container');

            // Guard against missing elements
            if (!svg || !container) return;

            // Clear existing content
            svg.innerHTML = '';

            // Get chart dimensions
            const rect = container.getBoundingClientRect();
            const width = rect.width - 48; // Account for padding
            const height = 300;
            const padding = { top: 20, right: 20, bottom: 40, left: 40 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

            // Get data for last 30 days
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 29);

            const sessions = getSessionsForDateRange(startDate, endDate);

            // Check if we have any data
            const hasData = sessions.some(s => s.pomodoro > 0 || s.youtube > 0);

            if (!hasData) {
                chartEmptyMessage.classList.remove('hide');
                return;
            }
            chartEmptyMessage.classList.add('hide');

            // Calculate max value for Y-axis
            let maxValue = 1;
            sessions.forEach(s => {
                if (viewMode === 'combined') {
                    maxValue = Math.max(maxValue, s.pomodoro + s.youtube);
                } else if (viewMode === 'pomodoro') {
                    maxValue = Math.max(maxValue, s.pomodoro);
                } else {
                    maxValue = Math.max(maxValue, s.youtube);
                }
            });

            // Add some headroom
            maxValue = Math.ceil(maxValue * 1.2) || 1;

            // Create scales
            const xDivisor = Math.max(sessions.length - 1, 1);
            const xScale = (index) => padding.left + (index / xDivisor) * chartWidth;
            const yScale = (value) => padding.top + chartHeight - (value / maxValue) * chartHeight;

            // Draw grid lines
            const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const gridLines = 5;
            for (let i = 0; i <= gridLines; i++) {
                const y = padding.top + (chartHeight / gridLines) * i;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', padding.left);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - padding.right);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'chart-grid');
                gridGroup.appendChild(line);

                // Y-axis labels
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                const value = Math.round(maxValue - (maxValue / gridLines) * i);
                label.setAttribute('x', padding.left - 8);
                label.setAttribute('y', y + 4);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('class', 'chart-label');
                label.textContent = value;
                gridGroup.appendChild(label);
            }
            svg.appendChild(gridGroup);

            // Draw X-axis labels (show every 5th day)
            const xLabelGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            sessions.forEach((s, i) => {
                if (i % 5 === 0 || i === sessions.length - 1) {
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    const date = new Date(s.date);
                    label.setAttribute('x', xScale(i));
                    label.setAttribute('y', height - padding.bottom + 20);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('class', 'chart-label');
                    // Validate date before displaying
                    if (isNaN(date.getTime())) {
                        label.textContent = '??';
                    } else {
                        label.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                    }
                    xLabelGroup.appendChild(label);
                }
            });
            svg.appendChild(xLabelGroup);

            // Draw axes
            const axisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            // X-axis
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', padding.left);
            xAxis.setAttribute('y1', height - padding.bottom);
            xAxis.setAttribute('x2', width - padding.right);
            xAxis.setAttribute('y2', height - padding.bottom);
            xAxis.setAttribute('class', 'chart-axis');
            axisGroup.appendChild(xAxis);
            // Y-axis
            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', padding.left);
            yAxis.setAttribute('y1', padding.top);
            yAxis.setAttribute('x2', padding.left);
            yAxis.setAttribute('y2', height - padding.bottom);
            yAxis.setAttribute('class', 'chart-axis');
            axisGroup.appendChild(yAxis);
            svg.appendChild(axisGroup);

            // Helper function to create path
            function createPath(data, className) {
                if (data.every(v => v === 0)) return null;

                // Create area path
                const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let areaD = `M ${xScale(0)} ${yScale(0)}`;
                data.forEach((value, i) => {
                    areaD += ` L ${xScale(i)} ${yScale(value)}`;
                });
                areaD += ` L ${xScale(data.length - 1)} ${yScale(0)} Z`;
                areaPath.setAttribute('d', areaD);
                areaPath.setAttribute('class', `chart-area ${className}`);
                svg.appendChild(areaPath);

                // Create line path
                const linePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let lineD = '';
                data.forEach((value, i) => {
                    lineD += i === 0 ? `M ${xScale(i)} ${yScale(value)}` : ` L ${xScale(i)} ${yScale(value)}`;
                });
                linePath.setAttribute('d', lineD);
                linePath.setAttribute('class', `chart-line ${className}`);
                svg.appendChild(linePath);

                return { areaPath, linePath };
            }

            // Create tooltip
            let tooltip = container.querySelector('.chart-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'chart-tooltip';
                container.appendChild(tooltip);
            }

            // Helper function to create dots
            function createDots(data, className, sessions) {
                data.forEach((value, i) => {
                    if (value > 0) {
                        const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        dot.setAttribute('cx', xScale(i));
                        dot.setAttribute('cy', yScale(value));
                        dot.setAttribute('r', 4);
                        dot.setAttribute('class', `chart-dot ${className}`);

                        // Tooltip on hover
                        dot.addEventListener('mouseenter', (e) => {
                            const date = new Date(sessions[i].date);
                            const dateStr = isNaN(date.getTime())
                                ? 'Unknown date'
                                : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            tooltip.innerHTML = `<strong>${dateStr}</strong><br>${value} session${value !== 1 ? 's' : ''}`;
                            tooltip.classList.add('visible');
                        });

                        dot.addEventListener('mousemove', (e) => {
                            const containerRect = container.getBoundingClientRect();
                            tooltip.style.left = `${e.clientX - containerRect.left + 10}px`;
                            tooltip.style.top = `${e.clientY - containerRect.top - 30}px`;
                        });

                        dot.addEventListener('mouseleave', () => {
                            tooltip.classList.remove('visible');
                        });

                        svg.appendChild(dot);
                    }
                });
            }

            // Draw lines based on view mode
            if (viewMode === 'combined' || viewMode === 'pomodoro') {
                const pomodoroData = sessions.map(s => s.pomodoro);
                createPath(pomodoroData, 'pomodoro');
                createDots(pomodoroData, 'pomodoro', sessions);
            }

            if (viewMode === 'combined' || viewMode === 'youtube') {
                const youtubeData = sessions.map(s => s.youtube);
                createPath(youtubeData, 'youtube');
                createDots(youtubeData, 'youtube', sessions);
            }

            // Add legend for combined view
            const existingLegend = container.querySelector('.chart-legend');
            if (existingLegend) {
                existingLegend.remove();
            }

            if (viewMode === 'combined') {
                const legend = document.createElement('div');
                legend.className = 'chart-legend';
                legend.innerHTML = `
                    <div class="legend-item">
                        <span class="legend-color pomodoro"></span>
                        <span>Work</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color youtube"></span>
                        <span>Quinlan Travels</span>
                    </div>
                `;
                container.appendChild(legend);
            }
        }

        // Render project summary for Quinlan Travels view
        function renderProjectSummary() {
            // Calculate project totals from session data (single source of truth)
            const projectTotals = getProjectSessionTotals();

            // Convert to array, filter out _unassigned, and sort by session count (descending)
            const projects = Object.entries(projectTotals)
                .filter(([name]) => name !== '_unassigned')
                .map(([name, data]) => ({ name, total: data.total, phases: data.phases }))
                .sort((a, b) => b.total - a.total);

            if (projects.length === 0) {
                projectList.innerHTML = '<div class="project-list-empty">No projects tracked yet</div>';
            } else {
                projectList.innerHTML = projects.map(p => {
                    // Build phase breakdown HTML
                    const phaseBreakdown = VIDEO_PHASES
                        .filter(phase => p.phases[phase.id] && p.phases[phase.id] > 0)
                        .map(phase => `<div class="phase-breakdown-item">${phase.label}: ${p.phases[phase.id]}</div>`)
                        .join('');

                    return `
                        <div class="project-list-item-wrapper">
                            <div class="project-list-item" data-project="${p.name}">
                                <span class="project-name">${p.name}</span>
                                <span class="project-count">${p.total} session${p.total !== 1 ? 's' : ''}</span>
                            </div>
                            ${phaseBreakdown ? `<div class="phase-breakdown hide">${phaseBreakdown}</div>` : ''}
                        </div>
                    `;
                }).join('');

                // Add click handlers to toggle phase breakdown
                projectList.querySelectorAll('.project-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const wrapper = item.closest('.project-list-item-wrapper');
                        const breakdown = wrapper.querySelector('.phase-breakdown');
                        if (breakdown) {
                            breakdown.classList.toggle('hide');
                            item.classList.toggle('expanded');
                        }
                    });
                });
            }
        }

        // Render priorities dashboard view
        function renderPrioritiesDashboard() {
            const priorityData = loadPriorities();
            const weekStats = getWeeklyPriorityStats();

            // Update week stats
            weekPriorityStats.innerHTML = `
                <div class="week-stat-item">
                    <div class="week-stat-value">${weekStats.completed}</div>
                    <div class="week-stat-label">Completed</div>
                </div>
                <div class="week-stat-item">
                    <div class="week-stat-value">${weekStats.total}</div>
                    <div class="week-stat-label">Total</div>
                </div>
                <div class="week-stat-item">
                    <div class="week-stat-value">${weekStats.percentage}%</div>
                    <div class="week-stat-label">Complete</div>
                </div>
            `;

            // Get last 7 days of priorities
            const days = Object.entries(priorityData.days)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 7);

            if (days.length === 0) {
                prioritiesHistory.innerHTML = '<div class="gratitude-empty-message">No priorities recorded yet</div>';
            } else {
                prioritiesHistory.innerHTML = days.map(([dateKey, dayData]) => {
                    const date = new Date(dateKey);
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const completed = dayData.priorities.filter(p => p.completed).length;
                    const total = dayData.priorities.length;

                    return `
                        <div class="priority-day-card">
                            <div class="priority-day-header">
                                <span>${dateStr}</span>
                                <span class="priority-day-completion">${completed}/${total}</span>
                            </div>
                            ${dayData.priorities.map(p => `
                                <div class="priority-history-item ${p.completed ? 'completed' : ''}">
                                    <div class="priority-history-check"></div>
                                    <span>${p.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            }
        }

        // Render gratitude dashboard view
        function renderGratitudeDashboard() {
            const gratitudeData = loadGratitude();

            // Update streak badge
            gratitudeStreakBadge.innerHTML = `
                <span class="streak-number">${gratitudeData.stats.currentStreak}</span>
                <span class="streak-label">day streak</span>
            `;

            // Get all entries sorted by date (most recent first)
            const entries = Object.entries(gratitudeData.entries)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 14); // Show last 2 weeks

            if (entries.length === 0) {
                gratitudeJournal.innerHTML = '<div class="gratitude-empty-message">No gratitude entries yet</div>';
            } else {
                gratitudeJournal.innerHTML = entries.map(([dateKey, entry]) => {
                    const date = new Date(dateKey);
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                    return `
                        <div class="gratitude-entry-card">
                            <div class="gratitude-entry-date">${dateStr}</div>
                            ${entry.items.map(item => `
                                <div class="gratitude-entry-item">${item}</div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            }
        }

        // Render the entire dashboard
        function renderDashboard() {
            // Hide all view-specific sections first
            projectSummary.classList.add('hide');
            prioritiesDashboard.classList.add('hide');
            gratitudeDashboard.classList.add('hide');
            chartContainer.classList.remove('hide');

            // Get river container
            const riverContainer = document.getElementById('dashboard-river-container');

            // Hide/show stat cards based on view
            statPriority.classList.add('hide');
            statGratitude.classList.add('hide');

            if (currentViewMode === 'priorities') {
                // Priorities view
                statPriority.classList.remove('hide');
                chartContainer.classList.add('hide');
                prioritiesDashboard.classList.remove('hide');
                if (riverContainer) riverContainer.classList.add('hide');

                const weekStats = getWeeklyPriorityStats();
                priorityPercentEl.textContent = `${weekStats.percentage}%`;

                // Update general stats with priorities data
                const priorityData = loadPriorities();
                daysActiveEl.textContent = priorityData.stats.totalDaysSet;
                const todayPriorities = getTodayPriorities();
                todaySessionsEl.textContent = todayPriorities ? todayPriorities.priorities.filter(p => p.completed).length : 0;
                totalSessionsEl.textContent = priorityData.stats.totalCompleted;

                renderPrioritiesDashboard();
            } else if (currentViewMode === 'gratitude') {
                // Gratitude view
                statGratitude.classList.remove('hide');
                chartContainer.classList.add('hide');
                gratitudeDashboard.classList.remove('hide');
                if (riverContainer) riverContainer.classList.add('hide');

                const gratitudeData = loadGratitude();
                gratitudeStreakEl.textContent = gratitudeData.stats.currentStreak;

                // Update general stats with gratitude data
                daysActiveEl.textContent = gratitudeData.stats.totalDaysRecorded;
                todaySessionsEl.textContent = getTodayGratitude() ? '1' : '0';
                totalSessionsEl.textContent = Object.keys(gratitudeData.entries).length;

                renderGratitudeDashboard();
            } else {
                // Session-based views (combined, pomodoro, youtube)
                const stats = calculateStats(currentViewMode);

                daysActiveEl.textContent = stats.daysActive;
                todaySessionsEl.textContent = stats.todaySessions;
                totalSessionsEl.textContent = stats.totalSessions;

                renderChart(currentViewMode);

                // Show project summary only for Quinlan Travels view
                if (currentViewMode === 'youtube') {
                    renderProjectSummary();
                    projectSummary.classList.remove('hide');
                }

                // Show and render river for session views
                if (riverContainer) {
                    riverContainer.classList.remove('hide');
                    if (typeof renderRiver === 'function') {
                        renderRiver('dashboard-river');
                    }
                }
            }
        }

        // ==========================================
        // VIEW MANAGEMENT
        // ==========================================

        function showDashboard() {
            dashboardView.classList.remove('hide');
            appContainer.style.display = 'none';
            document.querySelector('.session-counter').style.display = 'none';
            if (mainDashboardBtn) mainDashboardBtn.classList.add('hide');
            renderDashboard();
        }

        function hideDashboard() {
            dashboardView.classList.add('hide');
            appContainer.style.display = '';
            document.querySelector('.session-counter').style.display = '';
            if (mainDashboardBtn) mainDashboardBtn.classList.remove('hide');
            // Return to main three-panel view
            collapseAllSections();
        }

        function updateViewToggle(viewMode) {
            currentViewMode = viewMode;
            viewOptions.forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.view === viewMode);
            });
            renderDashboard();
        }

        // ==========================================
        // DASHBOARD EVENT LISTENERS
        // ==========================================

        // Dashboard buttons (main button and inside timer section)
        document.querySelectorAll('.dashboard-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDashboard();
            });
        });
        dashboardBackBtn.addEventListener('click', hideDashboard);
        clearDataBtn.addEventListener('click', clearAllData);

        viewOptions.forEach(option => {
            option.addEventListener('click', () => {
                updateViewToggle(option.dataset.view);
            });
        });

        // Re-render chart on window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (!dashboardView.classList.contains('hide')) {
                    renderChart(currentViewMode);
                }
            }, 250);
        });

        // Initialize session count from stored data
        sessionCount = getTodaySessionCount();
        if (sessionCountEl) sessionCountEl.textContent = sessionCount;

        // Update time-of-day emphasis every minute
        trackedIntervals.push(setInterval(() => {
            if (!expandedSection) {
                updateTimeOfDayEmphasis();
            }
        }, 60000));

        // Also update timer preview when timer is running
        trackedIntervals.push(setInterval(() => {
            if (isRunning && !expandedSection) {
                updateTimerCollapsedPreview();
            }
        }, 1000));

        // ==========================================
        // PROGRESS RIVER SYSTEM
        // ==========================================

        // Load river data from localStorage
        function loadRiverData() {
            return riverStorage.load();
        }

        // Save river data to localStorage
        function saveRiverData(data) {
            return riverStorage.save(data);
        }

        // Update river segment for today
        function updateRiverSegment() {
            const data = loadRiverData();
            const today = getTodayDateKey();
            const sessionData = loadSessionData();
            const prioritiesData = loadPriorities();
            const gratitudeData = loadGratitude();

            // Calculate today's stats
            const todaySessions = sessionData.sessions[today]
                ? (sessionData.sessions[today].pomodoro || 0) +
                  Object.values(sessionData.sessions[today].youtube || {}).reduce((sum, proj) => {
                      return sum + Object.values(proj).reduce((s, v) => s + v, 0);
                  }, 0)
                : 0;

            const todayPriorities = prioritiesData.days[today];
            let prioritiesCompleted = 0;
            let prioritiesTotal = 0;
            if (todayPriorities && todayPriorities.priorities) {
                prioritiesTotal = todayPriorities.priorities.length;
                prioritiesCompleted = todayPriorities.priorities.filter(p => p.completed).length;
            }

            const gratitudeRecorded = !!gratitudeData.entries[today];

            // Find or create today's segment
            let segmentIndex = data.segments.findIndex(s => s.date === today);
            if (segmentIndex === -1) {
                data.segments.push({
                    date: today,
                    sessions: todaySessions,
                    prioritiesCompleted: prioritiesCompleted,
                    prioritiesTotal: prioritiesTotal,
                    gratitudeRecorded: gratitudeRecorded
                });
            } else {
                data.segments[segmentIndex] = {
                    date: today,
                    sessions: todaySessions,
                    prioritiesCompleted: prioritiesCompleted,
                    prioritiesTotal: prioritiesTotal,
                    gratitudeRecorded: gratitudeRecorded
                };
            }

            // Sort by date and keep last 30 days
            data.segments.sort((a, b) => a.date.localeCompare(b.date));
            if (data.segments.length > 30) {
                data.segments = data.segments.slice(-30);
            }

            saveRiverData(data);
            return data;
        }

        // Render the river visualization
        function renderRiver(containerId, mini = false) {
            const data = loadRiverData();
            const container = document.getElementById(containerId);
            if (!container) return;

            const svg = container.querySelector('.river-svg') || container;
            const content = svg.querySelector('#river-content') || svg;

            // Clear existing content
            content.innerHTML = '';

            if (data.segments.length === 0) {
                // Show empty state
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '50%');
                text.setAttribute('y', '50%');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'rgba(0,0,0,0.3)');
                text.setAttribute('font-size', '14');
                text.setAttribute('font-family', 'Inter, sans-serif');
                text.textContent = 'Complete sessions to start your river';
                content.appendChild(text);
                return;
            }

            const today = getTodayDateKey();
            const daysToShow = mini ? 7 : 30;
            const width = mini ? 280 : 760;
            const height = mini ? 50 : 100;
            const padding = 20;
            const riverCenter = height / 2;

            // Update viewBox for mini river
            if (mini) {
                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            }

            // Generate the last N days
            const endDate = new Date();
            const days = [];
            for (let i = daysToShow - 1; i >= 0; i--) {
                const date = new Date(endDate);
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('sv'));
            }

            // Map segments to days
            const segmentMap = {};
            data.segments.forEach(s => segmentMap[s.date] = s);

            // Calculate segment width
            const segmentWidth = (width - padding * 2) / daysToShow;

            // Build river path
            let pathD = '';
            let lastY = riverCenter;
            let consecutiveDays = 0;

            days.forEach((dateKey, i) => {
                const segment = segmentMap[dateKey];
                const x = padding + i * segmentWidth + segmentWidth / 2;

                if (segment && segment.sessions > 0) {
                    // Calculate width based on sessions (3-15 pixels)
                    const riverWidth = Math.min(15, Math.max(3, segment.sessions * 2));

                    // River flows through this day
                    if (pathD === '') {
                        pathD = `M ${x - segmentWidth / 2} ${riverCenter}`;
                    }

                    // Add slight wave variation
                    const wave = Math.sin(i * 0.5) * 3;
                    pathD += ` Q ${x} ${riverCenter + wave}, ${x + segmentWidth / 2} ${riverCenter}`;

                    // Draw the segment
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x - segmentWidth / 2 + 2);
                    rect.setAttribute('y', riverCenter - riverWidth / 2);
                    rect.setAttribute('width', segmentWidth - 4);
                    rect.setAttribute('height', riverWidth);
                    rect.setAttribute('rx', riverWidth / 2);
                    rect.setAttribute('fill', segment.gratitudeRecorded ? 'url(#riverGradientWarm)' : 'url(#riverGradient)');
                    rect.setAttribute('class', 'river-wave' + (segment.prioritiesCompleted === segment.prioritiesTotal && segment.prioritiesTotal > 0 ? ' shimmer' : ''));

                    if (dateKey === today) {
                        rect.classList.add('river-segment-today');
                    }

                    // Add hover functionality
                    rect.style.cursor = 'pointer';
                    rect.dataset.date = dateKey;
                    rect.dataset.sessions = segment.sessions;
                    rect.dataset.priorities = `${segment.prioritiesCompleted}/${segment.prioritiesTotal}`;
                    rect.dataset.gratitude = segment.gratitudeRecorded ? 'Yes' : 'No';

                    rect.addEventListener('mouseenter', showRiverTooltip);
                    rect.addEventListener('mouseleave', hideRiverTooltip);

                    content.appendChild(rect);
                    consecutiveDays++;

                    // Check for milestones
                    if (consecutiveDays === 7 || consecutiveDays === 14 || consecutiveDays === 30) {
                        const milestone = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        milestone.setAttribute('cx', x);
                        milestone.setAttribute('cy', riverCenter);
                        milestone.setAttribute('r', 6);
                        milestone.setAttribute('class', 'river-milestone');
                        content.appendChild(milestone);
                    }
                } else {
                    // Gap day - draw shore
                    if (pathD !== '' && consecutiveDays > 0) {
                        // Draw a thin connecting line
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x - segmentWidth / 2);
                        line.setAttribute('y1', riverCenter);
                        line.setAttribute('x2', x + segmentWidth / 2);
                        line.setAttribute('y2', riverCenter);
                        line.setAttribute('stroke', 'rgba(210, 195, 170, 0.4)');
                        line.setAttribute('stroke-width', '1');
                        line.setAttribute('stroke-dasharray', '4,4');
                        content.appendChild(line);
                    }
                    consecutiveDays = 0;
                }
            });
        }

        // River tooltip functions
        function showRiverTooltip(e) {
            const tooltip = document.getElementById('river-tooltip');
            if (!tooltip) return;

            const rect = e.target.getBoundingClientRect();
            const date = new Date(e.target.dataset.date);
            const dateStr = isNaN(date.getTime())
                ? 'Unknown date'
                : date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            const dateEl = tooltip.querySelector('.river-tooltip-date');
            if (dateEl) dateEl.textContent = dateStr;
            const statsEl = tooltip.querySelector('.river-tooltip-stats');
            if (statsEl) {
                statsEl.innerHTML = `
                    Sessions: ${e.target.dataset.sessions}<br>
                    Priorities: ${e.target.dataset.priorities}<br>
                    Gratitude: ${e.target.dataset.gratitude}
                `;
            }

            tooltip.style.left = `${rect.left + rect.width / 2 - 60}px`;
            tooltip.style.top = `${rect.top - 70}px`;
            tooltip.classList.add('visible');
        }

        function hideRiverTooltip() {
            const tooltip = document.getElementById('river-tooltip');
            if (tooltip) tooltip.classList.remove('visible');
        }

        // Render mini river in gratitude collapsed view
        function renderMiniRiver() {
            const gratitudeCollapsed = document.getElementById('gratitude-collapsed-content');
            if (!gratitudeCollapsed) return;

            // Check if mini river container exists, if not create it
            let miniRiverDiv = gratitudeCollapsed.querySelector('.gratitude-mini-river');
            if (!miniRiverDiv) {
                miniRiverDiv = document.createElement('div');
                miniRiverDiv.className = 'gratitude-mini-river';
                miniRiverDiv.innerHTML = `
                    <div class="progress-river mini">
                        <svg class="river-svg" viewBox="0 0 280 50" preserveAspectRatio="xMidYMid meet">
                            <defs>
                                <linearGradient id="riverGradientMini" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#9fb8b5;stop-opacity:0.8"/>
                                    <stop offset="100%" style="stop-color:#7a9e9b;stop-opacity:1"/>
                                </linearGradient>
                                <linearGradient id="riverGradientWarmMini" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#b8c5a8;stop-opacity:0.8"/>
                                    <stop offset="100%" style="stop-color:#9fb8a0;stop-opacity:1"/>
                                </linearGradient>
                            </defs>
                            <g id="mini-river-content"></g>
                        </svg>
                    </div>
                `;
                gratitudeCollapsed.appendChild(miniRiverDiv);
            }

            // Render mini version
            const data = loadRiverData();
            const svg = miniRiverDiv.querySelector('.river-svg');
            const content = svg.querySelector('#mini-river-content');
            content.innerHTML = '';

            const today = getTodayDateKey();
            const daysToShow = 7;
            const width = 280;
            const height = 50;
            const padding = 10;
            const riverCenter = height / 2;

            // Generate the last 7 days
            const endDate = new Date();
            const days = [];
            for (let i = daysToShow - 1; i >= 0; i--) {
                const date = new Date(endDate);
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('sv'));
            }

            // Map segments to days
            const segmentMap = {};
            data.segments.forEach(s => segmentMap[s.date] = s);

            const segmentWidth = (width - padding * 2) / daysToShow;

            days.forEach((dateKey, i) => {
                const segment = segmentMap[dateKey];
                const x = padding + i * segmentWidth + segmentWidth / 2;

                if (segment && segment.sessions > 0) {
                    const riverWidth = Math.min(10, Math.max(2, segment.sessions * 1.5));
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x - segmentWidth / 2 + 1);
                    rect.setAttribute('y', riverCenter - riverWidth / 2);
                    rect.setAttribute('width', segmentWidth - 2);
                    rect.setAttribute('height', riverWidth);
                    rect.setAttribute('rx', riverWidth / 2);
                    rect.setAttribute('fill', segment.gratitudeRecorded ? 'url(#riverGradientWarmMini)' : 'url(#riverGradientMini)');
                    rect.setAttribute('class', 'river-wave');
                    if (dateKey === today) {
                        rect.classList.add('river-segment-today');
                    }
                    content.appendChild(rect);
                } else {
                    // Small dot for empty day
                    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    dot.setAttribute('cx', x);
                    dot.setAttribute('cy', riverCenter);
                    dot.setAttribute('r', 2);
                    dot.setAttribute('fill', 'rgba(210, 195, 170, 0.3)');
                    content.appendChild(dot);
                }
            });
        }

        // ==========================================
        // SESSION COMPLETION CEREMONY
        // ==========================================

        const completionCeremony = document.getElementById('completion-ceremony');
        const ceremonyStat = document.getElementById('ceremony-stat');
        const waterDrop = document.getElementById('water-drop');

        function showCompletionCeremony() {
            // Update the stat text
            const todayCount = getTodaySessionCount();
            ceremonyStat.textContent = todayCount === 1
                ? "That's 1 session today"
                : `That's ${todayCount} sessions today`;

            // Show the ceremony
            completionCeremony.classList.add('visible');

            // Auto-hide after 2.5 seconds
            setTimeout(() => {
                completionCeremony.classList.remove('visible');

                // Trigger water drop animation
                triggerWaterDrop();
            }, 2500);
        }

        function triggerWaterDrop() {
            // Position the drop at center-top
            waterDrop.style.left = '50%';
            waterDrop.style.top = '40%';
            waterDrop.style.transform = 'translateX(-50%)';

            // Trigger animation
            waterDrop.classList.add('animate');

            // Remove animation class after completion
            setTimeout(() => {
                waterDrop.classList.remove('animate');
            }, 1000);

            // Update river after drop lands
            setTimeout(() => {
                updateRiverSegment();
                renderMiniRiver();
                if (!document.querySelector('.dashboard-view').classList.contains('hide')) {
                    renderRiver('dashboard-river');
                }
            }, 800);
        }

        // ==========================================
        // ANIMATED NUMBER COUNT-UP
        // ==========================================

        function animateNumber(element, target, duration = 800) {
            if (!element) return;

            const start = 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Ease out cubic
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (target - start) * eased);

                // Handle percentage values
                if (element.textContent.includes('%')) {
                    element.textContent = current + '%';
                } else {
                    element.textContent = current;
                }

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            element.classList.add('counting');
            requestAnimationFrame(update);

            setTimeout(() => {
                element.classList.remove('counting');
            }, duration);
        }

        // Override the dashboard stats update to use animations
        const originalUpdateDashboardStats = typeof updateDashboardStats === 'function' ? updateDashboardStats : null;

        // Wrap updateDashboardStats to add animations
        function animatedUpdateDashboardStats() {
            const daysActiveEl = document.getElementById('days-active');
            const todaySessionsEl = document.getElementById('today-sessions');
            const totalSessionsEl = document.getElementById('total-sessions');
            const priorityPercentEl = document.getElementById('priority-percent');
            const gratitudeStreakEl = document.getElementById('gratitude-streak');

            // Get current values before update
            const oldDays = parseInt(daysActiveEl?.textContent) || 0;
            const oldToday = parseInt(todaySessionsEl?.textContent) || 0;
            const oldTotal = parseInt(totalSessionsEl?.textContent) || 0;

            // Calculate new values
            const stats = calculateStats(currentViewMode);

            // Animate if values changed
            if (daysActiveEl && stats.daysActive !== oldDays) {
                animateNumber(daysActiveEl, stats.daysActive);
            } else if (daysActiveEl) {
                daysActiveEl.textContent = stats.daysActive;
            }

            if (todaySessionsEl && stats.todaySessions !== oldToday) {
                animateNumber(todaySessionsEl, stats.todaySessions);
            } else if (todaySessionsEl) {
                todaySessionsEl.textContent = stats.todaySessions;
            }

            if (totalSessionsEl && stats.totalSessions !== oldTotal) {
                animateNumber(totalSessionsEl, stats.totalSessions);
            } else if (totalSessionsEl) {
                totalSessionsEl.textContent = stats.totalSessions;
            }

            // Render river in dashboard
            renderRiver('dashboard-river');
        }

        // ==========================================
        // INTEGRATION: Update existing functions
        // ==========================================

        // Store reference to original dashboard show function
        const dashboardViewEl = document.querySelector('.dashboard-view');

        // Override dashboard button click to trigger animations
        const originalDashboardBtn = document.getElementById('main-dashboard-btn');
        if (originalDashboardBtn) {
            originalDashboardBtn.addEventListener('click', () => {
                setTimeout(() => {
                    // Render river when dashboard opens
                    updateRiverSegment();
                    renderRiver('dashboard-river');
                }, 100);
            });
        }

        // Initialize river on page load
        updateRiverSegment();
        renderMiniRiver();

        // ==========================================
        // CLEANUP ON PAGE UNLOAD
        // ==========================================
        window.addEventListener('beforeunload', () => {
            // Clear all tracked intervals
            trackedIntervals.forEach(id => clearInterval(id));
            // Clear timer interval
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>